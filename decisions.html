<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RO‑WAI · Decisions</title>
  <!-- Tailwind (via CDN for preview) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome (icons) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkfE9QZ7eEKe0ZrFjG7lrRB7dN2V8gJ7x1kz0V+1qZ9V8VQ2Yf5pXg6sw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- SheetJS for reading Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    :root{
      --uga-red:#BA0C2F;
      --uga-black:#000000;
      --uga-gray:#554F47;
    }
    .nav-link[aria-current="page"], .nav-link.active{
      background-image: linear-gradient(to bottom right, var(--uga-red), #ec4899);
      color:#fff; box-shadow: inset 0 2px 4px rgba(0,0,0,.4);
    }
    .nav-link:hover{ background-image: linear-gradient(to bottom right, #e5e7eb, #9ca3af); color:#111; }
    .glass-effect { background: rgba(255, 255, 255, 0.4); box-shadow:0 5px 12px rgba(0,0,0,.25); }

    body.dark-uga {

      /* Background image with UGA brand gradient overlay */
      background-image:
              linear-gradient(rgba(255,255,255,0.7), rgba(229,229,229,0.7), rgba(209,213,219,0.7), rgba(186,12,47,0.3)),
              url('https://www.uga.edu/img/prism-background.57f15081.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    /* Glass card look for decisions */
    #pending-root > * {
      border-radius: .75rem;          /* rounded-lg */
      background: rgba(255,255,255,.4); /* same as .glass-effect */
      box-shadow: 0 5px 12px rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,.35);
      padding: 1rem;                  /* p-4 */
    }


  </style>
</head>
<body class="dark-uga">
<div class="min-h-screen w-full relative overflow-hidden">
  <div class="max-w-[1620px] mx-auto p-10 sm:p-12 lg:p-14">
      <!-- Header (borrowed from your current canvas, with Decisions active) -->
      <div id="site-header"></div>
      <!-- On every page, after <div id="site-header"></div> -->
      <script>
        (async () => {
          const target = document.getElementById('site-header');
          if (!target) return;

          try {
            // 1) Fetch & inject the partial
            const res = await fetch('partials/header.html', { cache: 'no-store' });
            if (!res.ok) throw new Error('Failed to load header');
            const html = await res.text();
            target.innerHTML = html;

            // 2) Execute any <script> tags in the injected HTML
            const scripts = target.querySelectorAll('script');
            for (const oldScript of scripts) {
              const s = document.createElement('script');
              if (oldScript.src) {
                s.src = oldScript.src;
                s.async = false;
              } else {
                s.textContent = oldScript.textContent;
              }
              // Use head so it executes in document context
              document.head.appendChild(s);
              oldScript.remove();
            }
          } catch (err) {
            console.error('Header load failed', err);
          }
        })();
      </script>
    <main class="relative z-10">

<div class="">
  <h2 class="text-6xl font-semibold mb-4 text-[#4a4a4a]">DECISIONS</h2>

  <!-- Tabs -->
  <div class="flex items-center gap-2 mb-6" role="tablist" aria-label="Decisions tabs">
    <button id="tab-pending" role="tab" aria-selected="true" class="tab-btn px-3 py-2 rounded-md border border-gray-300 bg-white text-xl hover:bg-gray-100">
      Pending <span id="count-pending" class="count-badge ml-2 inline-flex items-center justify-center min-w-6 px-2 py-0.5 text-lg text-black rounded-full bg-gray-200">0</span>
    </button>
    <button id="tab-complete" role="tab" aria-selected="false" class="tab-btn px-3 py-2 rounded-md border border-gray-300 bg-white text-xl hover:bg-gray-100">
      Complete <span id="count-complete" class="count-badge ml-2 inline-flex items-center justify-center min-w-6 px-2 py-0.5 text-lg text-black rounded-full bg-gray-200">0</span>
    </button>
  </div>

  <!-- Pending view: interactive form grouped by category -->
  <section id="view-pending" role="tabpanel" aria-labelledby="tab-pending" class="space-y-8">
    <div id="pending-root" class="space-y-6"></div>
    <div class="pt-2">
      <button id="submit-decisions" class="mt-2 px-4 py-2 bg-[var(--uga-red)] text-white rounded-lg shadow hover:bg-pink-600">
        <i class="fa-solid fa-paper-plane mr-2"></i>Submit Decisions
      </button>
      <span class="ml-3 text-sm text-gray-600">Only answered items are submitted and marked complete.</span>
    </div>
  </section>

  <!-- Complete view: table of prior decisions (mark_complete = yes) -->
  <section id="view-complete" role="tabpanel" aria-labelledby="tab-complete" class="hidden">
    <div class="overflow-auto rounded-lg border border-gray-200 bg-white">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50 text-gray-700">
        <tr>
          <th class="text-left px-4 py-2">Category</th>
          <th class="text-left px-4 py-2">#</th>
          <th class="text-left px-4 py-2">Decision</th>
          <th class="text-left px-4 py-2">Answer</th>
          <th class="text-left px-4 py-2">Comment</th>
        </tr>
        </thead>
        <tbody id="complete-tbody" class="divide-y divide-gray-100"></tbody>
      </table>
    </div>
  </section>
</div>

  <!-- Category filter chips (auto-built) -->
  <div id="categoryChips" class="flex flex-wrap gap-2 mb-6" aria-label="Filter by category"></div>

  <!-- Decisions container (auto-built) -->
  <div id="decisionsRoot" class="space-y-6"></div>

    </main>
  </div>
</div>
</body>

<!-- Toast -->
<div id="toast" class="fixed bottom-4 right-4 hidden px-4 py-3 rounded-lg shadow-lg bg-black/80 text-white text-sm" role="status" aria-live="polite"></div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  // Replace with your actual CSV/Excel URL (Google Sheets export or similar)
  // -- Google Sheets config --
  // 1) Put your Google Sheet **ID** (the long string in the URL)
  const SHEET_ID = "1naeWFQsNyjY3g0yNeZHcAg5VW-DTdOehH_Zjy3pCe7k";
  // 2) Open the "Decisions" tab in the browser and copy the **gid** value from the URL
  const DECISIONS_GID = "673751497";
  // 3) Make sure the sheet is shared at least "Anyone with link: Viewer" OR "Publish to the web"
  const DECISIONS_CSV = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${DECISIONS_GID}`;

  // Endpoint to write back to the sheet (Apps Script / webhook)
  // Accepts an array of objects with keys matching the sheet headers
  const SUBMIT_URL = "https://script.google.com/macros/s/AKfycbx1GFhYvCZnil9NFVcljpG5Bs2JeqFgoKjeRz28ogWxVrNYpw3GANwyAsEujQfu3J2Cqw/exec";  // e.g. https://script.google.com/macros/s/…/exec

  // ===== Helpers =====
  const qs = (s, el=document) => el.querySelector(s);
  const qsa = (s, el=document) => Array.from(el.querySelectorAll(s));
  const toast = (msg) => { const t=qs('#toast'); t.textContent = msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 2200); };
  const isYes = v => String(v||'').trim().toLowerCase() === 'yes';
  const slug = s => String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-');

  function sortByCategoryAndNumber(rows){
    rows.sort((a,b)=>{
      const c = String(a.category_title||'').localeCompare(String(b.category_title||''));
      if(c!==0) return c;
      const na = parseInt(a.decision_number,10), nb = parseInt(b.decision_number,10);
      if(!isNaN(na) && !isNaN(nb)) return na-nb;
      return String(a.decision_number||'').localeCompare(String(b.decision_number||''));
    });
    return rows;
  }

  // ===== Data Fetch =====
  async function fetchDecisions(){
    return new Promise((resolve,reject)=>{
      Papa.parse(DECISIONS_CSV, {
        header: true,
        download: true,
        skipEmptyLines: true,
        complete: (res)=> resolve(res.data || []),
        error: reject
      });
    });
  }

  // ===== Render Pending (interactive) =====
  function renderPending(rows){
    const root = qs('#pending-root');
    root.innerHTML = '';

    // group by category
    const byCat = rows.reduce((acc,r)=>{ (acc[r.category_title] ||= []).push(r); return acc; },{});
    const cats = Object.keys(byCat).sort((a,b)=> a.localeCompare(b));

    cats.forEach(cat =>{
      const section = document.createElement('section');
      section.className = 'bg-white rounded-xl shadow border border-gray-200 p-4';
      section.innerHTML = `<h3 class="text-3xl font-semibold mb-3">${cat}</h3>`;

      byCat[cat].forEach(r =>{
        const id = `${slug(r.category_title)}-${slug(r.decision_number)}`;
        const block = document.createElement('article');
        block.dataset.decision = '1';
        block.dataset.category = r.category_title || '';
        block.dataset.number = r.decision_number || '';
        block.dataset.text = r.decision_text || '';
        block.className = ' p-4 mb-4';
        block.innerHTML = `
          <div class="flex items-start justify-between gap-4">
            <div class="min-w-0 ">
              <div class="flex items-center gap-2 mb-1">
                <span class="inline-flex items-center justify-center w-7 h-7 text-xl font-semibold rounded-md bg-[#4a4a4a] text-white " aria-hidden="true">${r.decision_number||''}</span>
                <p class="text-xl font-semibold">${r.decision_text||''}</p>
              </div>
            </div>
            </div>
              <div class="mt-3 flex items-center gap-x-4 gap-y-3">

            <fieldset class="shrink-0" aria-label="Decision ${r.decision_number}">
              <div class="flex gap-3">
                <label class="yes-pill inline-flex items-center gap-2 px-3 py-2 rounded-md border border-gray-300 cursor-pointer bg-gray-50 hover:bg-white">
        <input type="radio" name="ans-${id}" value="Yes" class="sr-only">
        <span class="select-none">Yes</span>
      </label>
      <label class="no-pill inline-flex items-center gap-2 px-3 py-2 rounded-md border border-gray-300 cursor-pointer bg-gray-50 hover:bg-white">
        <input type="radio" name="ans-${id}" value="No" class="sr-only">
        <span class="select-none">No</span>
      </label>

                 <!-- Defer: looks like a pill, no input -->
      <button type="button"
              class="defer-btn inline-flex items-center gap-2 px-3 py-2 rounded-md border border-gray-300 cursor-pointer bg-gray-50 hover:bg-white"
              aria-label="Defer this question">
        Defer
      </button>
              </div>
            </fieldset>


  <!-- quieter, inline comment with fixed height -->
  <label class="sr-only" for="cmt-${id}">Optional comment</label>
  <input id="cmt-${id}" type="text"
  class="ml-4 px-3 h-9 rounded-md border border-gray-200 text-sm text-gray-600 bg-gray-50 min-w-[260px]"
  placeholder="Optional note…">
</div>
            `;

        // prefill if any
        const ans = String(r.decision_answer||'').trim();
        if(ans === 'Yes' || ans === 'No'){
          const input = block.querySelector(`input[name='ans-${id}'][value='${ans}']`);
          if(input) input.checked = true;
        }
        const cmt = String(r.decision_comment||'').trim();
        if(cmt) block.querySelector(`#cmt-${id}`).value = cmt;
        const yesLabel  = block.querySelector('.yes-pill');
        const noLabel   = block.querySelector('.no-pill');
        const deferBtn  = block.querySelector('.defer-btn');
        const PRESSED = ['bg-gradient-to-br','from-[var(--uga-red)]','to-pink-500','text-white','shadow-inner'];

        function clearPressed() {
          [yesLabel, noLabel, deferBtn].forEach(el => el && el.classList.remove(...PRESSED));
        }
        function press(el) {
          if (el) el.classList.add(...PRESSED);
        }

// Existing label click: make Yes/No look pressed and clear Defer
        block.addEventListener('click', (e) => {
          const lab = e.target.closest('label');
          if (!lab) return;
          const input = lab.querySelector('input');
          if (!input) return; // ignore Defer (no input)
          const v = input.value; // "Yes" or "No"
          clearPressed();
          press(v === 'Yes' ? yesLabel : noLabel);
        });

// Defer click: uncheck radios, press the Defer pill
        deferBtn.addEventListener('click', (e) => {
          e.preventDefault();
          block.querySelectorAll(`input[name='ans-${id}']`).forEach(r => r.checked = false);
          clearPressed();
          press(deferBtn);
        });

        // pressed look on choose
        block.addEventListener('click', (e)=>{
          const label = e.target.closest('label'); if(!label) return;
          const v = label.querySelector('input')?.value; if(!v) return;
          const yes = block.querySelector(`input[name='ans-${id}'][value='Yes']`).parentElement;
          const no  = block.querySelector(`input[name='ans-${id}'][value='No']`).parentElement;
          [yes,no].forEach(el=> el.classList.remove('bg-gradient-to-br','from-[var(--uga-red)]','to-pink-500','text-white'));
          (v==='Yes' ? yes : no).classList.add('bg-gradient-to-br','from-[var(--uga-red)]','to-pink-500','text-white');
        });



        section.appendChild(block);
      });

      root.appendChild(section);
    });
  }

  // ===== Render Complete (table) =====
  function renderComplete(rows){
    const tbody = qs('#complete-tbody');
    tbody.innerHTML = '';
    sortByCategoryAndNumber(rows).forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-4 py-2 align-top">${r.category_title||''}</td>
        <td class="px-4 py-2 align-top">${r.decision_number||''}</td>
        <td class="px-4 py-2 align-top">${r.decision_text||''}</td>
        <td class="px-4 py-2 align-top">${r.decision_answer||''}</td>
        <td class="px-4 py-2 align-top">${r.decision_comment||''}</td>`;
      tbody.appendChild(tr);
    });
  }

  // ===== Collect & Submit =====
  function collectAnswered(){
    const rows = [];
    qsa('[data-decision]').forEach(block =>{
      const category_title = block.dataset.category;
      const decision_number = block.dataset.number;
      const decision_text   = block.dataset.text;
      const id = `${slug(category_title)}-${slug(decision_number)}`;
      const chosen = document.querySelector(`input[name='ans-${id}']:checked`);
      if(!chosen) return; // only answered
      const decision_answer = chosen.value;
      const decision_comment = (qs(`#cmt-${id}`)?.value || '').trim();
      rows.push({
        category_title,
        decision_number,
        decision_text,
        decision_answer,
        decision_comment,
        mark_complete: 'yes'
      });
    });
    return rows;
  }

  async function submitAnswered(){
    const payload = collectAnswered();
    if(payload.length===0){ toast('No answers selected.'); return; }
    try{
      if(!SUBMIT_URL || SUBMIT_URL.includes('YOUR_')){ toast('Set SUBMIT_URL to your Apps Script Web App URL'); console.warn('Missing SUBMIT_URL'); return; }
      const res = await fetch(SUBMIT_URL, { method:'POST', headers:{'Content-Type':'text/plain'}, body: JSON.stringify(payload)});
      const text = await res.text();
      let j; try { j = JSON.parse(text); } catch { j = null; }
      if(!res.ok || !j || j.ok === false){ console.error('Submit failed', {status: res.status, text}); throw new Error((j && j.error) || `Submit failed (status ${res.status})`); }
      toast('Decisions submitted.');
      return true;
    }catch(err){ console.error(err); toast('Error submitting decisions'); return false; }
  }

  // ===== Tabs =====
  function setTab(which){
    const isPending = which === 'pending';
    qs('#tab-pending').setAttribute('aria-selected', String(isPending));
    qs('#tab-complete').setAttribute('aria-selected', String(!isPending));
    qs('#view-pending').classList.toggle('hidden', !isPending);
    qs('#view-complete').classList.toggle('hidden', isPending);
    // visual
    qsa('.tab-btn').forEach(b=> b.classList.remove('bg-gradient-to-br','from-[var(--uga-red)]','to-pink-500','text-white'));
    qs(isPending ? '#tab-pending' : '#tab-complete').classList.add('bg-gradient-to-br','from-[var(--uga-red)]','to-pink-500','text-white');
  }

  // ===== Init =====
  let ALL_ROWS = [];

  async function refresh(){
    ALL_ROWS = sortByCategoryAndNumber(await fetchDecisions());
    const complete = ALL_ROWS.filter(r=> isYes(r.mark_complete));
    const pending  = ALL_ROWS.filter(r=> !isYes(r.mark_complete));
    // counts
    qs('#count-pending').textContent = pending.length;
    qs('#count-complete').textContent = complete.length;
    // render
    renderPending(pending);
    renderComplete(complete);
  }

  document.addEventListener('DOMContentLoaded', async () =>{
    // wire tabs
    qs('#tab-pending').addEventListener('click', ()=> setTab('pending'));
    qs('#tab-complete').addEventListener('click', ()=> setTab('complete'));
    setTab('pending');

    await refresh();

    // submit
    qs('#submit-decisions').addEventListener('click', async ()=>{
      const ok = await submitAnswered();
      if(ok){
        // Optimistic refresh: refetch the sheet to move submitted items to Complete
        await refresh();
        setTab('complete');
      }
    });
  });
</script>
</body>
</html>
