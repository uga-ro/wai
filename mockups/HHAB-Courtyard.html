<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap" rel="stylesheet">

<!-- === UGA Form Styles (same as your other forms) === -->
<style>
    .uga-form, .uga-form * {font-family: "Merriweather", "Georgia", serif !important;  box-sizing: border-box; }
    .uga-form { padding: 16px; }
    .uga-form form#form-hhab-courtyard {
        max-width: 700px; margin: 2rem auto; background: #fff;
        padding: 24px 28px; border-radius: 14px;
        border-top: 6px solid #ba0c2f; box-shadow: 0 6px 22px rgba(0,0,0,.1);
    }
    .uga-form h2 {
        font-weight: 800; font-size: 1.6rem; color: #ba0c2f; text-align: center; margin: 0 0 1.25rem;
    }
    .uga-form .field { margin-bottom: 18px; }
    .uga-form label { display: block; font-weight: 700; margin: 0 0 8px; color: #4a4a4a; }
    .uga-form .required { color: #ba0c2f; margin-left: 4px; }
    .uga-form .styled-input {
        display: block; width: 100%; padding: 14px 16px; border-radius: 10px;
        border: 1.5px solid #c7c7c7; background: linear-gradient(180deg,#fff 0%,#f6f6f6 100%);
        font-size: 18px; line-height: 1.35; color: #222;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.05);
        transition: border-color .15s, box-shadow .15s, background .15s;
    }
    .uga-form .styled-input:hover { border-color: #a8a8a8; background: #ffffff; }
    .uga-form .styled-input:focus-visible {
        border-color: #00a3ad; background: #ffffff; outline: none;
        box-shadow: 0 0 0 3px rgba(0,163,173,.25), inset 0 1px 2px rgba(0,0,0,0.08);
    }
    .uga-form input.styled-input:-webkit-autofill {
        -webkit-box-shadow: 0 0 0px 1000px #fff inset !important; -webkit-text-fill-color: #222 !important; caret-color:#222;
    }
    .uga-form .hint { margin-top: 6px; font-size: .925rem; color: #606060; }
    .uga-form button {
        margin-top: 22px; width: 100%; padding: 16px 20px; background: linear-gradient(90deg,#ba0c2f,#a00a28);
        color:#fff; border:0; border-radius:10px; font-size:18px; font-weight:800; letter-spacing:.2px; cursor:pointer;
        box-shadow: 0 3px 8px rgba(0,0,0,.15); transition: transform .08s, filter .2s, box-shadow .2s;
    }
    .uga-form button:hover { filter: brightness(1.06); }
    .uga-form button:active { transform: scale(.985); }
    .uga-form button:disabled { filter: grayscale(.25) brightness(.95); cursor:not-allowed; box-shadow:none; }
    .uga-form #status { text-align:center; margin-top:16px; font-weight:700; font-size:1.1rem; transition: all .25s; }
    .uga-form #status.success {
        color:#007d85; background: rgba(0,163,173,0.08); border:2px solid #00a3ad;
        border-radius:10px; padding:14px 18px; margin-top:20px; box-shadow:0 4px 12px rgba(0,163,173,0.15);
    }
    .uga-form #status.error {
        color:#ba0c2f; background: rgba(186,12,47,0.08); border:2px solid #ba0c2f;
        border-radius:10px; padding:14px 18px; margin-top:20px; box-shadow:0 4px 12px rgba(186,12,47,0.12);
    }
    .uga-form .styled-input.is-invalid {
        border-color:#ba0c2f;
        box-shadow:0 0 0 3px rgba(186,12,47,.18);
        animation: shake 0.4s ease-in-out;
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
        20%, 40%, 60%, 80% { transform: translateX(4px); }
    }

    @media (prefers-reduced-motion: reduce) {
        .uga-form .styled-input, .uga-form button { transition:none; }
        .uga-form .styled-input.is-invalid { animation: none; }
    }
</style>

<div class="uga-form">
    <form id="form-hhab-courtyard" novalidate>
        <h2>HHAB Courtyard 0120-BN01 Request</h2>

        <!-- Instructional text (insttext1) -->
        <div class="field" aria-live="polite">
            <div class="hint" style="line-height:1.4">
                <div style="text-align: center;"><strong>Holmes Hunter Academic Building</strong></div>
                <div style="text-align: center;"><strong>Courtyard 0120-BN01</strong></div>
                <div style="text-align: center;"><strong>Default Capacity: 120<br/>Currenty Setup Capacity: 64</strong></div>
                <br/><strong>Only specified UGA departments are eligible to reserve the Holmes Hunter Academic Building Courtyard upon approval.</strong><br/><br/>
                <ul><li>These departments and organizations are fully responsible for the coordination of the event, compliance with building policies and procedures, and damage to facilities and equipment during their event.</li></ul>
                <ul><li>Should the event require catering and/or chairs &amp; tables:</li></ul>
                <ul><li style="list-style-type: none;">
                    <ul style="list-style-type: circle;">
                        <li>A representative from your department must be on site to receive and coordinate delivery of these items.</li>
                    </ul>
                </li></ul>
                <ul><li style="list-style-type: none;">
                    <ul style="list-style-type: circle;">
                        <li>The Registrar's Office does not provide additional furniture beyond what is available in the courtyard. You must submit a work order to the Facilities Management Division for custodial and furniture fees and setup. <a href="https://readyfmd.fmd.uga.edu/ready/">https://readyfmd.fmd.uga.edu/ready/</a></li>
                    </ul>
                </li></ul>
                <ul><li style="list-style-type: none;">
                    <ul style="list-style-type: circle;">
                        <li>The courtyard must be restored to its original state, including removal of all trash.</li>
                    </ul>
                </li></ul>
                <br/><span style="text-decoration: underline;">The Holmes Hunter Courtyard is not available for events after 5pm, during weekends, or on dates the University is closed.</span>
                <br/><br/><span style="text-decoration: underline;"><strong>Please provide the following contact and event information:</strong></span>
            </div>
        </div>

        <!-- Fields -->
        <div class="field">
            <label for="ugaDepartment">UGA Department<span class="required">*</span></label>
            <input id="ugaDepartment" name="ugaDepartment" class="styled-input" type="text" required>
            <div class="hint">Enter the UGA department or unit associated with this request.</div>
        </div>

        <div class="field">
            <label for="primaryContactName">Primary Contact Name<span class="required">*</span></label>
            <input id="primaryContactName" name="primaryContactName" class="styled-input" type="text" required>
            <div class="hint">Enter the name of the person primarily responsible for this request.</div>
        </div>

        <div class="field">
            <label for="title">Title<span class="required">*</span></label>
            <input id="title" name="title" class="styled-input" type="text" required>
            <div class="hint">Enter the title of the primary contact.</div>
        </div>

        <div class="field">
            <label for="email">Email<span class="required">*</span></label>
            <input id="email" name="email" class="styled-input" type="email" required>
            <div class="hint">Enter the email address of the primary contact.</div>
        </div>

        <div class="field">
            <label for="departmentPhoneNumber">Department Phone Number<span class="required">*</span></label>
            <input id="departmentPhoneNumber" name="departmentPhoneNumber" class="styled-input" type="tel" required>
            <div class="hint">Enter the phone number of the UGA department submitting this request.</div>
        </div>

        <div class="field">
            <label for="primaryContactCellPhoneNumber">Primary Contact Cell Phone Number<span class="required">*</span></label>
            <input id="primaryContactCellPhoneNumber" name="primaryContactCellPhoneNumber" class="styled-input" type="tel" required>
            <div class="hint">Enter the cell phone number of the primary contact.</div>
        </div>

        <div class="field">
            <label for="additionalContactName">Additional Contact Name (optional)</label>
            <input id="additionalContactName" name="additionalContactName" class="styled-input" type="text">
            <div class="hint">Enter the name of an additional contact person for this request.</div>
        </div>

        <div class="field">
            <label for="additionalContactEmail">Additional Contact Email (optional)</label>
            <input id="additionalContactEmail" name="additionalContactEmail" class="styled-input" type="email">
            <div class="hint">Enter the email address of the additional contact.</div>
        </div>

        <div class="field">
            <label for="additionalContactPhoneNumber">Additional Contact Phone Number (optional)</label>
            <input id="additionalContactPhoneNumber" name="additionalContactPhoneNumber" class="styled-input" type="tel">
            <div class="hint">Enter the phone number of the additional contact.</div>
        </div>

        <div class="field">
            <label for="dateOfTheEvent">Date of the Event<span class="required">*</span></label>
            <input id="dateOfTheEvent" name="dateOfTheEvent" class="styled-input" type="text" placeholder="MM/DD/YYYY" required>
            <div class="hint">Enter the date the event will take place.</div>
        </div>

        <div class="field">
            <label for="eventStartAndEndTime">Event Start and End Time<span class="required">*</span></label>
            <input id="eventStartAndEndTime" name="eventStartAndEndTime" class="styled-input" type="text" placeholder="e.g., 1:00 PM - 3:30 PM (include setup/teardown)" required>
            <div class="hint">Enter the start and end times for the event. Please include setup and teardown times. Same-day and next-day reservations cannot be honored. Please allow five (5) business days for processing.</div>
        </div>

        <div class="field">
            <label for="eventNameAndDescription">Event Name and Description<span class="required">*</span></label>
            <textarea id="eventNameAndDescription" name="eventNameAndDescription" class="styled-input" rows="3" required></textarea>
            <div class="hint">Enter a name for the event as well as a brief description.</div>
        </div>

        <div class="field">
            <label for="numberOfAttendees">Number of Attendees<span class="required">*</span></label>
            <input id="numberOfAttendees" name="numberOfAttendees" class="styled-input" type="number" min="1" step="1" required>
            <div class="hint">Enter the number of expected attendees.</div>
        </div>

        <div class="field">
            <label>Will you serve food at your event?<span class="required">*</span></label>
            <label style="display:flex;gap:10px;align-items:center;font-weight:600;">
                <input type="radio" name="willServeFood" value="Yes, food will be served.">
                Yes, food will be served.
            </label>
            <label style="display:flex;gap:10px;align-items:center;font-weight:600;margin-top:6px;">
                <input type="radio" name="willServeFood" value="No, food will not be served.">
                No, food will not be served.
            </label>

        </div>

        <div class="field">
            <label for="chartStringOrSpeedTypeAccountNum">Chart String or Speed Type Account Number<span class="required">*</span></label>
            <input id="chartStringOrSpeedTypeAccountNum" name="chartStringOrSpeedTypeAccountNum" class="styled-input" type="text" required>
            <div class="hint">The Registrar's Office will submit a work order to FMD for opening/closing and access. Provide the billable Chart String or Speed Type account number.</div>
        </div>

        <!-- Closing instructional text (insttext17) -->
        <div class="field" aria-live="polite">
            <div class="hint" style="line-height:1.5">
                Once processed, you will receive a confirmation email from
                <a href="mailto:classrooms@uga.edu">classrooms@uga.edu</a>.<br/><br/>
                The Holmes Hunter Academic Building is managed by the Office of the Registrar. Questions? Contact Crystal Oliver at
                <a href="mailto:crystal.graham25@uga.edu">Crystal.Oliver@uga.edu</a>.
            </div>
        </div>

        <button type="submit">Submit Request</button>
        <div id="status"></div>
    </form>
</div>

<script>
    /* === Configure for this form === */
    const FLOW_URL = "https://defaulta8216c1e4d6343528c3b50fa1f1475.b1.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/b69698dfb1134baba506c91b328b80bb/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=JGDOVGTIiRkzaZQUW5i7Tol_DVX-TaAm7Kn6ueB3qWM";
    const SECRET   = "uga-forms-25live-SECRET-7uU2Fr9p4XcQhB3L";

    /* === Validation helpers === */
    const form = document.getElementById('form-hhab-courtyard');
    const statusBox = document.getElementById('status');
    const markInvalid = el => el.classList.add('is-invalid');
    const clearInvalid = el => el.classList.remove('is-invalid');
    const isEmail = v => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
    const isPhone10 = v => v.replace(/[^\d]/g,'').length >= 10;

    /* === Phone formatting === */
    const phoneLastValues = new Map();

    function formatPhoneInput(e) {
        let input = e.target;
        let cursorPos = input.selectionStart;
        let value = input.value;
        let lastValue = phoneLastValues.get(input) || '';

        // Remove all non-digit and non-formatting characters
        let cleaned = value.replace(/[^\d()\s\-]/g, '');

        // Extract just the digits
        let digits = cleaned.replace(/[^\d]/g, '');
        let lastDigits = lastValue.replace(/[^\d]/g, '');

        // Detect if user deleted a formatting character (length decreased but digit count stayed same)
        let deletedFormatChar = value.length < lastValue.length && digits.length === lastDigits.length;

        // Limit to 10 digits
        digits = digits.substring(0, 10);

        // If user deleted a format character, just show the cleaned digits without auto-formatting
        let formatted = '';
        if (deletedFormatChar) {
            // Don't auto-format, just use cleaned input
            formatted = cleaned;
        } else {
            // Normal formatting
            if (digits.length > 0) {
                formatted = '(' + digits.substring(0, 3);
                if (digits.length > 3) {
                    formatted += ') ' + digits.substring(3, 6);
                }
                if (digits.length > 6) {
                    formatted += '-' + digits.substring(6, 10);
                }
            }
        }

        // Calculate new cursor position
        let newCursorPos = cursorPos;
        if (!deletedFormatChar && formatted.length > value.length) {
            // Auto-formatting added characters, move cursor forward
            newCursorPos = cursorPos + (formatted.length - value.length);
        }

        // Update value and store for next time
        input.value = formatted;
        phoneLastValues.set(input, formatted);

        // Set cursor position
        input.setSelectionRange(newCursorPos, newCursorPos);
    }

    function formatPhoneForSubmit(value) {
        const digits = value.replace(/[^\d]/g, '');
        if (digits.length === 10) {
            return `(${digits.substring(0, 3)}) ${digits.substring(3, 6)}-${digits.substring(6, 10)}`;
        }
        return value;
    }

    /* === Date formatting === */
    let lastDateValue = '';

    function formatDateInput(e) {
        let input = e.target;
        let cursorPos = input.selectionStart;
        let value = input.value;
        let lastValue = lastDateValue;

        // Remove all non-digit and non-slash characters
        let cleaned = value.replace(/[^\d\/]/g, '');

        // Extract just the digits
        let digits = cleaned.replace(/[^\d]/g, '');
        let lastDigits = lastValue.replace(/[^\d]/g, '');

        // Detect if user deleted a formatting character (length decreased but digit count stayed same)
        let deletedFormatChar = value.length < lastValue.length && digits.length === lastDigits.length;

        // Limit to 8 digits (MMDDYYYY)
        digits = digits.substring(0, 8);

        // If user deleted a format character, just show the cleaned input without auto-formatting
        let formatted = '';
        if (deletedFormatChar) {
            // Don't auto-format, just use cleaned input
            formatted = cleaned;
        } else {
            // Normal formatting
            if (digits.length > 0) {
                formatted = digits.substring(0, 2);
                if (digits.length >= 2) {
                    formatted += '/';
                }
                if (digits.length > 2) {
                    formatted += digits.substring(2, 4);
                }
                if (digits.length >= 4) {
                    formatted += '/';
                }
                if (digits.length > 4) {
                    formatted += digits.substring(4, 8);
                }
            }
        }

        // Calculate new cursor position
        let newCursorPos = cursorPos;
        if (!deletedFormatChar && formatted.length > value.length) {
            // Auto-formatting added characters, move cursor forward
            newCursorPos = cursorPos + (formatted.length - value.length);
        }

        // Update value and store for next time
        input.value = formatted;
        lastDateValue = formatted;

        // Set cursor position
        input.setSelectionRange(newCursorPos, newCursorPos);
    }

    function isValidDate(dateStr) {
        const regex = /^(0[1-9]|1[0-2])\/(0[1-9]|[12][0-9]|3[01])\/\d{4}$/;
        if (!regex.test(dateStr)) return false;

        const parts = dateStr.split('/');
        const month = parseInt(parts[0], 10);
        const day = parseInt(parts[1], 10);
        const year = parseInt(parts[2], 10);

        const date = new Date(year, month - 1, day);
        return date.getFullYear() === year &&
               date.getMonth() === month - 1 &&
               date.getDate() === day;
    }

    function validate() {
        statusBox.textContent = ''; statusBox.className = '';
        let ok = true;

        const req = [
            form.ugaDepartment, form.primaryContactName, form.title, form.email,
            form.departmentPhoneNumber, form.primaryContactCellPhoneNumber,
            form.dateOfTheEvent, form.eventStartAndEndTime,
            form.eventNameAndDescription, form.numberOfAttendees,
            form.chartStringOrSpeedTypeAccountNum
        ];
        req.forEach(clearInvalid);
        req.forEach(f => { if(!f.value.trim()){ markInvalid(f); ok = false; } });

        if (form.email.value && !isEmail(form.email.value.trim())) { markInvalid(form.email); ok = false; }
        if (form.additionalContactEmail.value && form.additionalContactEmail.value.trim() && !isEmail(form.additionalContactEmail.value.trim())) { markInvalid(form.additionalContactEmail); ok = false; }

        if (form.departmentPhoneNumber.value && !isPhone10(form.departmentPhoneNumber.value)) { markInvalid(form.departmentPhoneNumber); ok = false; }
        if (form.primaryContactCellPhoneNumber.value && !isPhone10(form.primaryContactCellPhoneNumber.value)) { markInvalid(form.primaryContactCellPhoneNumber); ok = false; }
        if (form.additionalContactPhoneNumber.value && form.additionalContactPhoneNumber.value.trim() && !isPhone10(form.additionalContactPhoneNumber.value)) { markInvalid(form.additionalContactPhoneNumber); ok = false; }

        // date validation
        if (form.dateOfTheEvent.value && !isValidDate(form.dateOfTheEvent.value.trim())) { markInvalid(form.dateOfTheEvent); ok = false; }

        if (Number(form.numberOfAttendees.value) < 1) { markInvalid(form.numberOfAttendees); ok = false; }

        const hasFoodChoice = Array.from(form.querySelectorAll('input[name="willServeFood"]')).some(r => r.checked);
        if (!hasFoodChoice) ok = false;

        if (!ok) {
            statusBox.className = 'error';
            statusBox.textContent = 'Please complete all required fields (and fix highlights) before submitting.';
            const first = document.querySelector('.is-invalid');
            if (first) first.scrollIntoView({ behavior:'smooth', block:'center' });
        }
        return ok;
    }
    form.addEventListener('input', e => { if (e.target.classList) clearInvalid(e.target); });
    form.addEventListener('change', e => { if (e.target.classList) clearInvalid(e.target); });

    /* === Attach phone formatters === */
    form.departmentPhoneNumber.addEventListener('input', formatPhoneInput);
    form.primaryContactCellPhoneNumber.addEventListener('input', formatPhoneInput);
    form.additionalContactPhoneNumber.addEventListener('input', formatPhoneInput);

    /* === Attach date formatter === */
    form.dateOfTheEvent.addEventListener('input', formatDateInput);

    /* === Submit === */
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!validate()) return;
        const submitBtn = form.querySelector('button');
        submitBtn.disabled = true;

        const willServeFood = (
            Array.from(form.querySelectorAll('input[name="willServeFood"]')).find(r => r.checked)?.value
        ) || "";


        const body = {
            secret: SECRET,
            ugaDepartment: form.ugaDepartment.value.trim(),
            primaryContactName: form.primaryContactName.value.trim(),
            title: form.title.value.trim(),
            email: form.email.value.trim(),
            departmentPhoneNumber: formatPhoneForSubmit(form.departmentPhoneNumber.value.trim()),
            primaryContactCellPhoneNumber: formatPhoneForSubmit(form.primaryContactCellPhoneNumber.value.trim()),
            additionalContactName: form.additionalContactName.value.trim(),
            additionalContactEmail: form.additionalContactEmail.value.trim(),
            additionalContactPhoneNumber: formatPhoneForSubmit(form.additionalContactPhoneNumber.value.trim()),
            dateOfTheEvent: form.dateOfTheEvent.value.trim(),
            eventStartAndEndTime: form.eventStartAndEndTime.value.trim(),
            eventNameAndDescription: form.eventNameAndDescription.value.trim(),
            numberOfAttendees: form.numberOfAttendees.value.trim(),
            willServeFood,
            chartStringOrSpeedTypeAccountNum: form.chartStringOrSpeedTypeAccountNum.value.trim()
        };

        try {
            const res = await fetch(FLOW_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });
            const text = await res.text();
            if (!res.ok) throw new Error(res.status + ' ' + res.statusText + ': ' + text);

            statusBox.className = "success";
            statusBox.textContent = "Thank you! Your HHAB Courtyard request has been submitted.";
            form.reset();
            statusBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } catch (err) {
            statusBox.className = "error";
            statusBox.textContent = "Error submitting form: " + err.message;
            statusBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } finally {
            submitBtn.disabled = false;
        }
    });
</script>
