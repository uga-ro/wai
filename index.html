<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>RO‑WAI · Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@600;700;800&family=Manrope:wght@400;600;700&family=IBM+Plex+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --uga-red: #BA0C2F; --uga-black: #000000; --uga-gray: #554F47; --uga-white: #FFFFFF;
            --uga-light-gray: #F7F7F7; --uga-border-gray: #E5E5E5;
            --p-high:#BA0C2F; --p-med:#DD6B20; --p-low:#2F855A;
            --g0:#121419; --g1:#1A1F26; --g2:#232933; --g3:#2C333E; --g4:#38414D; --g5:#454F5E; --w0:#F7F8FA; --redAlpha:.35;
        }
        body { font-family:'Inter',sans-serif; background-color:var(--uga-light-gray); color:var(--uga-gray); }
        .glass-effect { background: rgba(255, 255, 255, 0.4); box-shadow:0 5px 12px rgba(0,0,0,.25); }

        /* Striped progress */
        .progress{--pct:0;position:relative;height:25px;border-radius:4px;background:#E5E7EB;overflow:hidden}
        .progress>span{content:"";position:absolute;inset:0;width:calc(var(--pct)*1%);
            background:repeating-linear-gradient(45deg,var(--uga-red) 0 10px,#E02E4C 10px 20px);
        }


        .mini-table{width:100%;border-collapse:collapse;margin-top:10px}
        .mini-table th,.mini-table td{padding:8px 10px;border-top:1px solid var(--uga-border-gray);text-align:left}
        .mini-table thead{background:rgba(0,0,0,.03)}
        /* Only center the 2nd column */
        .mini-table th:nth-child(2),
        .mini-table td:nth-child(2) {
            text-align: center;
        }

        .dot{display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:05%;background:#CBD5E0;color:#fff;font-size:14px;font-weight:700}
        .dot::before{content:"–"}.dot.ok{background: #4ac581
                                 }  .dot.ok::before{content:"✓"}  .dot.progress{ background: #ffd037; }        /* orange */
        td:empty::after{ content:"\00a0"; }         /* keep cell height if empty */
        .legend{font-size:.8rem;color:var(--uga-gray);margin-top:6px}
        .counter{display:inline-block;background: #f5f5f5; margin-left:8px;padding:.15rem .5rem;border:1px solid var(--uga-border-gray);border-radius:6px;font-size:.8rem;color:var(--uga-gray)}
        .badge{display:inline-block;padding:.35rem .6rem;border-radius:999px;font-size:.75rem;border:1px solid var(--uga-border-gray);background:#fff}
        .badge--solid{background:var(--uga-black);color:#fff;border-color:var(--uga-black);font-weight:600}
        .wrap{max-width:1620px;margin:auto;padding:24px}
        .legend{display:none}
        /* Fixed background layer (no more “moving” while expanding) */
        body.dark-uga {

            /* Background image with UGA brand gradient overlay */
            background-image:
                    linear-gradient(rgba(255,255,255,0.7), rgba(229,229,229,0.7), rgba(209,213,219,0.7), rgba(186,12,47,0.3)),
                    url('https://www.uga.edu/img/prism-background.57f15081.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        /*linear-gradient(rgba(255,255,255,0.8), rgba(229,229,229,0.9), rgba(209,213,219,0.9), rgba(186,12,47,0.3)),*/
        nav a.nav-link.bg-gradient-to-br {
            color: #fff !important;
        }
        /* Accordion */
        .acc{border-radius:.75rem}
        .acc-header{display:flex;align-items:flex-start;justify-content:space-between;width:100%;gap:.75rem;text-align:left}
        .acc-panel{overflow:hidden;max-height:0;opacity:0;transition:max-height .28s ease, opacity .2s ease}
        .acc[aria-expanded="true"] .acc-panel{opacity:1}
        @media (prefers-reduced-motion:reduce){.acc-panel{transition:none}}
        .chev{transition:transform .2s ease}.acc[aria-expanded="true"] .chev{transform:rotate(180deg)}
        /* Let columns be different heights */
        #categoriesGrid{align-items:start}



    </style>
</head>

<body class="dark-uga">
<div class="min-h-screen w-full relative overflow-hidden">
    <div class="max-w-[1620px] mx-auto p-10 sm:p-12 lg:p-14">

            <!-- Header (borrowed from your current canvas, with Decisions active) -->
            <div id="site-header"></div>
            <!-- On every page, after <div id="site-header"></div> -->
            <script>
                (async () => {
                    const target = document.getElementById('site-header');
                    if (!target) return;

                    try {
                        // 1) Fetch & inject the partial
                        const res = await fetch('partials/header.html', { cache: 'no-store' });
                        if (!res.ok) throw new Error('Failed to load header');
                        const html = await res.text();
                        target.innerHTML = html;

                        // 2) Execute any <script> tags in the injected HTML
                        const scripts = target.querySelectorAll('script');
                        for (const oldScript of scripts) {
                            const s = document.createElement('script');
                            if (oldScript.src) {
                                s.src = oldScript.src;
                                s.async = false;
                            } else {
                                s.textContent = oldScript.textContent;
                            }
                            // Use head so it executes in document context
                            document.head.appendChild(s);
                            oldScript.remove();
                        }
                    } catch (err) {
                        console.error('Header load failed', err);
                    }
                })();
            </script>

        <main class="relative z-10">
            <!-- KPI Cards -->
            <section id="kpi" class="grid gap-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 mb-6">
                <div class="bg-gradient-to-br from-[#000] to-[#9EA2A2] glass-effect p-6 rounded-xl">
                    <h2 class="text-xl font-medium text-[var(--uga-white)]">Overall Progress</h2>
                    <p id="overall-text" class="text-2xl font-bold mt-1 text-white">—</p>
                    <div class="progress mt-2" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                        <span id="overall-bar" style="width:0%"></span>
                    </div>
                </div>
                <div class="glass-effect p-6 rounded-xl">
                    <h2 class="text-sm font-medium text-[var(--uga-gray)] mb-2">Progress By Content Type</h2>
                    <ul id="by-type" class="list-none p-0 m-0 grid gap-2"></ul>
                </div>

                <div class="bg-gradient-to-br from-[var(--uga-red)] to-pink-500 glass-effect p-6 rounded-xl">
                    <h2 class="text-xl font-medium text-[white]">Time to checkpoint</h2>
                    <div id="days-to" class="text-4xl font-bold mt-1 text-[white]">—</div>
                    <div class="text-[white] text-xl">Until April 15, 2026</div>
                </div>

                <div class="glass-effect p-6 rounded-xl">
                    <div>
                        <div class="text-sm font-medium text-[var(--uga-gray)] uppercase tracking-wider">In Dev</div>
                        <div id="in-dev-title" class="font-semibold text-black mt-1">—</div>
                        <div id="in-dev-meta" class="text-xs text-[var(--uga-gray)]">—</div>
                    </div>
                    <div class="mt-3 border-t border-[var(--uga-border-gray)] pt-3">
                        <div class="text-sm font-medium text-[var(--uga-gray)] uppercase tracking-wider">In Testing</div>
                        <div id="in-test-title" class="font-semibold text-black mt-1">—</div>
                        <div id="in-test-meta" class="text-xs text-[var(--uga-gray)]">—</div>
                    </div>
                </div>
            </section>

            <!-- Category Details (4 categories only) -->
            <section>
                <h2 class="text-2xl font-bold mb-4 text-black">Web Content Categories</h2>
                <div id="categoriesGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                    <!-- WebApps -->
                    <article
                            class="glass-effect p-0 acc"
                            id="cat-webapps"
                            data-sheet="WebApps"
                            data-step1="Plan"
                            data-step2="Build"
                            data-step3="Test"
                            aria-expanded="false">

                        <button class="acc-header w-full p-6" aria-controls="panel-webapps" aria-expanded="false">
                            <div class="w-full">
                                <div class="flex items-center gap-3 justify-between">
                                    <h3 class="text-2xl font-semibold text-black m-0">WebApps</h3>
                                    <div class="flex items-center gap-3">
                                        <span class="counter">0/0 complete</span>
                                    </div>
                                </div>
                                <div class="progress mt-2" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                                    <span style="width:0%"></span>
                                </div>
                            </div>
                            <svg class="chev w-5 h-5 text-[var(--uga-gray)] ml-4 shrink-0" viewBox="0 0 24 24" fill="none"
                                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>

                        <div id="panel-webapps" class="acc-panel px-6 pb-6" role="region" aria-labelledby="cat-webapps">
                            <p class="text-sm mt-0">Modernize apps to be accessible with semantic labels, focus management, keyboard flows, input labels, etc.</p>
                            <div class="overflow-x-auto">
                                <table class="mini-table" aria-label="WebApps progress table">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </article>

                    <!-- Forms -->
                    <article
                            class="glass-effect p-0 acc"
                            id="cat-forms"
                            data-sheet="Forms"
                            data-step1="Plan"
                            data-step2="Build"
                            data-step3="Test"
                            aria-expanded="false">

                        <button class="acc-header w-full p-6" aria-controls="panel-forms" aria-expanded="false">
                            <div class="w-full">
                                <div class="flex items-center gap-3 justify-between">
                                    <h3 class="text-2xl font-semibold text-black m-0">Forms</h3>
                                    <div class="flex items-center gap-3">
                                        <span class="counter">0/0 complete</span>
                                    </div>
                                </div>
                                <div class="progress mt-2" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                                    <span style="width:0%"></span>
                                </div>
                            </div>
                            <svg class="chev w-5 h-5 text-[var(--uga-gray)] ml-4 shrink-0" viewBox="0 0 24 24" fill="none"
                                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>

                        <div id="panel-forms" class="acc-panel px-6 pb-6" role="region" aria-labelledby="cat-forms">
                            <p class="text-sm mt-0">All forms need accessible tagging, labels, instructions, error handling, and alt paths.</p>
                            <div class="overflow-x-auto">
                                <table class="mini-table" aria-label="Forms progress table">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </article>

                    <!-- PDFs & Docs -->
                    <article
                            class="glass-effect p-0 acc"
                            id="cat-pdfs"
                            data-sheet="PDFs"
                            data-step1="Plan"
                            data-step2="Fix"
                            data-step3="Test"
                            aria-expanded="false">

                        <button class="acc-header w-full p-6" aria-controls="panel-pdfs" aria-expanded="false">
                            <div class="w-full">
                                <div class="flex items-center gap-3 justify-between">
                                    <h3 class="text-2xl font-semibold text-black m-0">PDFs &amp; Docs</h3>
                                    <div class="flex items-center gap-3">
                                        <span class="counter">0/0 complete</span>
                                    </div>
                                </div>
                                <div class="progress mt-2" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                                    <span style="width:0%"></span>
                                </div>
                            </div>
                            <svg class="chev w-5 h-5 text-[var(--uga-gray)] ml-4 shrink-0" viewBox="0 0 24 24" fill="none"
                                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>

                        <div id="panel-pdfs" class="acc-panel px-6 pb-6" role="region" aria-labelledby="cat-pdfs">
                            <p class="text-sm mt-0">All PDFs must be either marked as archival, converted to static HTML pages, or remedied to be accessible.</p>
                            <div class="overflow-x-auto">
                                <table class="mini-table" aria-label="PDFs &amp; Docs progress table">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </article>

                    <!-- Images & Videos -->
                    <article
                            class="glass-effect p-0 acc"
                            id="cat-media"
                            data-sheet="Media"
                            data-step1="Plan"
                            data-step2="Fix"
                            data-step3="Test"
                            aria-expanded="false">

                        <button class="acc-header w-full p-6" aria-controls="panel-media" aria-expanded="false">
                            <div class="w-full">
                                <div class="flex items-center gap-3 justify-between">
                                    <h3 class="text-2xl font-semibold text-black m-0">Images &amp; Videos</h3>
                                    <div class="flex items-center gap-3">
                                        <span class="counter">0/0 complete</span>
                                    </div>
                                </div>
                                <div class="progress mt-2" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                                    <span style="width:0%"></span>
                                </div>
                            </div>
                            <svg class="chev w-5 h-5 text-[var(--uga-gray)] ml-4 shrink-0" viewBox="0 0 24 24" fill="none"
                                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>

                        <div id="panel-media" class="acc-panel px-6 pb-6" role="region" aria-labelledby="cat-media">
                            <p class="text-sm mt-0">All non-decorative images must have alternative text. All videos must have captions and transcripts.</p>
                            <div class="overflow-x-auto">
                                <table class="mini-table" aria-label="Images &amp; Videos progress table">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </article>


                </div>
            </section>
        </main>
    </div>
</div>


<!-- PapaParse for CSV parsing -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
    (() => {
        /* ===============================
         *  CONFIG
         * =============================== */
        const SHEET_ID = '1naeWFQsNyjY3g0yNeZHcAg5VW-DTdOehH_Zjy3pCe7k'; // e.g., 1AbCDe...xyz
        const CHECKPOINT_DATE = '2026-04-24';
        const PIPELINE = {
            inDev:  { title: 'CASIS', due: '2025-09-30' },
            inTest: { title: 'Form: Address Change', due: '2025-09-19' }
        };

        /* ===============================
  *  HELPERS
  * =============================== */
        const $ = s => document.querySelector(s);
        const daysUntil = d => Math.ceil((new Date(d + 'T00:00:00') - new Date()) / 86400000);
        const fmtDate = d => new Date(d + 'T00:00:00').toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'});

        // Build a CSV URL for a given tab name (doc must be viewable or published)
        const csvUrlForSheet = (sheetName) =>
            `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}&v=${Date.now()}`;

        // Normalize dropdown/checkbox/number/spelling → 'todo' | 'wip' | 'done'
        const norm = (v) => {
            const t = String(v ?? '').trim().toLowerCase();
            // DONE
            if (t === '2' || t === 'done' || t === 'complete' || t === 'completed' ||
                t === 'true' || t === 'yes' || t === 'ok' || t === '✅') return 'done';
            // IN PROGRESS
            if (t === '1' || t === 'in progress' || t === 'in-progress' || t === 'progress' ||
                t === 'wip' || t === '⏳') return 'wip';
            // TODO (includes “To do” with a space)
            if (t === '0' || t === 'todo' || t === 'to do' || t === 'not started' ||
                t === 'false' || t === '' || t === '-' || t === '—') return 'todo';
            return 'todo';
        };

        // Table header: 2 columns (Item + combined steps label)
        const headerHTML = (labels) => {
            const [a,b,c] = labels;
            return `
      <tr>
        <th scope="col">Item</th>
        <th scope="col" class="w-56">${a} / ${b} / ${c}</th>
      </tr>`;
        };

        // Micro segmented bar (3 tiny segments: gray default, orange for wip, green for done)
        function microBarHTML(statuses, labels=['Plan','Build','Test']) {
            const colors = { done: 'bg-green-500', wip: 'bg-amber-400', todo: 'bg-gray-300' };
            const [s1, s2, s3] = statuses.map(s => colors[s] || colors.todo);
            const aria = `${labels[0]} ${statuses[0]==='done'?'done':statuses[0]==='wip'?'in progress':'to do'}, ` +
                `${labels[1]} ${statuses[1]==='done'?'done':statuses[1]==='wip'?'in progress':'to do'}, ` +
                `${labels[2]} ${statuses[2]==='done'?'done':statuses[2]==='wip'?'in progress':'to do'}`;
            return `
    <div class="flex items-center  justify-center w-full gap-2" role="group" aria-label="${aria}">
      <div class="flex gap-2" aria-hidden="true">
        <span class="h-4 w-4 rounded-[2px] ${s1}"></span>
        <span class="h-4 w-4 rounded-[2px] ${s2}"></span>
        <span class="h-4 w-4 rounded-[2px] ${s3}"></span>
      </div>
    </div>`;
        }


        // Ensure pending cells keep row height even when blank elsewhere
        function ensureCellStyle(){
            if (!document.querySelector('#microbar-aux-style')) {
                const s = document.createElement('style');
                s.id = 'microbar-aux-style';
                s.textContent = `td:empty::after{content:"\\00a0"}`;
                document.head.appendChild(s);
            }
        }

        /* ===============================
         *  CATEGORY RENDERER
         * =============================== */
        async function renderCategory(article){
            const sheetName = article.dataset.sheet || null;     // recommended
            const directCsv = article.dataset.csv || null;       // alt: published per-tab CSV
            const url = sheetName ? csvUrlForSheet(sheetName)
                : directCsv  ? (directCsv + (directCsv.includes('?') ? '&' : '?') + 'v=' + Date.now())
                    : null;

            const s1Label = article.dataset.step1 || 'Plan';
            const s2Label = article.dataset.step2 || 'Build';
            const s3Label = article.dataset.step3 || 'Test';

            // Find or create the table
            let table = article.querySelector('table.mini-table');
            if (!table) {
                table = document.createElement('table');
                table.className = 'mini-table';
                table.setAttribute('aria-label', (article.querySelector('h3')?.textContent || 'Category') + ' progress table');
                article.querySelector('.acc-panel')?.appendChild(table);
            }
            let thead = table.querySelector('thead');
            let tbody = table.querySelector('tbody');
            if (!thead) { thead = document.createElement('thead'); table.prepend(thead); }
            if (!tbody) { tbody = document.createElement('tbody'); table.appendChild(tbody); }

            thead.innerHTML = headerHTML([s1Label, s2Label, s3Label]);

            const counterEl = article.querySelector('.counter');
            const progBar   = article.querySelector('.acc-header .progress');
            const progFill  = article.querySelector('.acc-header .progress > span');

            if (!url) {
                tbody.innerHTML = `<tr><td colspan="2" class="text-sm text-gray-500">No data source specified</td></tr>`;
                return { name:'(missing)', done:0, total:0, pct:0 };
            }

            // Fetch + parse CSV
            let rows = [];
            try {
                const res  = await fetch(url);
                const text = await res.text();
                const out  = Papa.parse(text, { header:true, skipEmptyLines:true });
                rows = Array.isArray(out.data) ? out.data : [];
            } catch (e) {
                console.error('CSV load error', url, e);
                tbody.innerHTML = `<tr><td colspan="2" class="text-sm text-gray-500">Could not load data</td></tr>`;
                return { name:'(error)', done:0, total:0, pct:0 };
            }

// Expect (new): slug, category, title, description, original_url, new_url,
//               s1, s2, s3, s1_label, s2_label, s3_label
            tbody.innerHTML = '';
            let total = 0, doneCount = 0;

            rows.forEach(r => {
                // New source of display text; keep old 'name' as fallback just in case
                const title = (r.title || r.name || '').trim();
                if (!title) return;

                // Status columns are unchanged in spirit—now coming from the new sheet
                const s1 = norm(r.s1), s2 = norm(r.s2), s3 = norm(r.s3);
                const isDone = (s1==='done' && s2==='done' && s3==='done');
                if (isDone) doneCount++;
                total++;

                // The index view only needs slug + title; link target remains the same
                const link = r.slug
                    ? `<a href="item.html?slug=${encodeURIComponent(String(r.slug).trim())}" style="text-decoration:none;color:#BA0C2F">${title}</a>`
                    : title;

                tbody.insertAdjacentHTML('beforeend', `
    <tr>
      <td>${link}</td>
      <td>${microBarHTML([s1, s2, s3], [s1Label, s2Label, s3Label])}</td>
    </tr>
  `);
            });


            const pct = total ? Math.round((doneCount/total)*100) : 0;
            if (counterEl) counterEl.textContent = `${doneCount}/${total} complete`;
            if (progBar)  progBar.setAttribute('aria-valuenow', pct);
            if (progFill) progFill.style.width = pct + '%';

            // Let the accordion re-measure if open
            article.dispatchEvent(new Event('cat:updated'));

            return {
                name: article.querySelector('h3')?.textContent?.trim() || 'Category',
                done: doneCount, total, pct
            };
        }

        /* ===============================
         *  INIT & KPI ROLLUP
         * =============================== */
        async function init(){
            ensureCellStyle();

            // Optional KPI bits (if elements exist)
            const dEl = $('#days-to');
            if (dEl) dEl.textContent = `${daysUntil(CHECKPOINT_DATE)} days`;

            if (PIPELINE.inDev) {
                const t = $('#in-dev-title'), m = $('#in-dev-meta');
                if (t) t.textContent = PIPELINE.inDev.title;
                if (m) m.textContent = `Due ${fmtDate(PIPELINE.inDev.due)}`;
            }
            if (PIPELINE.inTest) {
                const t = $('#in-test-title'), m = $('#in-test-meta');
                if (t) t.textContent = PIPELINE.inTest.title;
                if (m) m.textContent = `Due ${fmtDate(PIPELINE.inTest.due)}`;
            }

            // Render categories present on the page
            const catEls = [
                document.getElementById('cat-webapps'),
                document.getElementById('cat-forms'),
                document.getElementById('cat-pdfs'),
                document.getElementById('cat-media'),
            ].filter(Boolean);

            const results = [];
            for (const el of catEls) {
                results.push(await renderCategory(el));
            }

            // KPI rollup
            const cats = results.filter(Boolean);
            const totals = cats.reduce((a,c)=>({done:a.done+c.done, total:a.total+c.total}), {done:0, total:0});
            const overallPct = totals.total ? Math.round((totals.done/totals.total)*100) : 0;

            const txt = $('#overall-text');
            const bar = $('#overall-bar');
            const prog = $('#kpi .progress');
            if (txt)  txt.textContent = `${totals.done} of ${totals.total} items complete`;
            if (bar)  bar.style.width = overallPct + '%';
            if (prog) prog.setAttribute('aria-valuenow', overallPct);

            // By-type list
            const list = $('#by-type');
            if (list) {
                list.innerHTML = '';
                cats.forEach(c=>{
                    list.insertAdjacentHTML('beforeend', `
          <li>
            <div class="flex justify-between items-center mb-1">
              <span class="text-sm">${c.name}</span>
              <span class="text-xs font-mono text-[var(--uga-gray)]">${c.pct}%</span>
            </div>
            <div class="progress" style="height:6px"><span style="width:${c.pct}%"></span></div>
          </li>
        `);
                });
            }
        }

        // Run after DOM is ready
        if (document.readyState !== 'loading') init();
        else document.addEventListener('DOMContentLoaded', init);
    })();
</script>
<script>
    (() => {
        const singleOpen = false; // set to true if you want only one open at a time

        function setPanelHeight(panel, open) {
            if (!panel) return;
            if (open) {
                panel.style.maxHeight = panel.scrollHeight + 'px';
                panel.style.opacity = '1';
            } else {
                panel.style.maxHeight = '0px';
                panel.style.opacity = '0';
            }
        }

        function bindAccordion(article) {
            const btn = article.querySelector('.acc-header');
            const panelId = btn?.getAttribute('aria-controls');
            const panel = panelId && document.getElementById(panelId);
            if (!btn || !panel) return;

            // initial state
            article.setAttribute('aria-expanded', 'false');
            btn.setAttribute('aria-expanded', 'false');
            setPanelHeight(panel, false);

            function toggle(next) {
                if (singleOpen && next) {
                    document.querySelectorAll('.acc[aria-expanded="true"]').forEach(a => {
                        if (a !== article) {
                            a.setAttribute('aria-expanded', 'false');
                            const b = a.querySelector('.acc-header');
                            const p = document.getElementById(b?.getAttribute('aria-controls'));
                            if (b) b.setAttribute('aria-expanded', 'false');
                            setPanelHeight(p, false);
                        }
                    });
                }
                article.setAttribute('aria-expanded', String(next));
                btn.setAttribute('aria-expanded', String(next));
                setPanelHeight(panel, next);
            }

            btn.addEventListener('click', () => {
                const next = article.getAttribute('aria-expanded') !== 'true';
                toggle(next);
            });

            btn.addEventListener('keydown', (e) => {
                if (e.key === ' ' || e.key === 'Enter') {
                    e.preventDefault();
                    const next = article.getAttribute('aria-expanded') !== 'true';
                    toggle(next);
                }
            });

            // Recalculate height when content changes or window resizes
            const ro = new ResizeObserver(() => {
                if (article.getAttribute('aria-expanded') === 'true') setPanelHeight(panel, true);
            });
            ro.observe(panel);

            window.addEventListener('resize', () => {
                if (article.getAttribute('aria-expanded') === 'true') setPanelHeight(panel, true);
            });

            // Allow external scripts (like your CSV loader) to tell us to re-measure:
            article.addEventListener('cat:updated', () => {
                if (article.getAttribute('aria-expanded') === 'true') setPanelHeight(panel, true);
            });
        }

        function initAccordions() {
            document.querySelectorAll('.acc').forEach(bindAccordion);
        }

        if (document.readyState !== 'loading') initAccordions();
        else document.addEventListener('DOMContentLoaded', initAccordions);
    })();
</script>


</body>
</html>
