<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>RO-WAI • Item Template (Design Mock)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root{
            --uga-red:#BA0C2F;
            --uga-black:#000;
            --uga-white:#fff;
            --uga-gray:#554F47;
            --muted:#6b7280;
            --ok:#16a34a;
            --line:#e5e7eb;
            --card:#ffffffF2;
            --ring: rgb(186, 12, 47);
            --step-w: 5rem;    /* .step width */
            --circle-d: 5rem;  /* circle diameter */
            --accent: #ba0c2f; /* blue-500 */
        }
        *{box-sizing:border-box}
        body{
            margin:0; color:#0f172a;
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";

                /* Static background image */
            /* Background image with UGA brand gradient overlay */
            background-image:
                    linear-gradient(rgba(255,255,255,0.8), rgba(229,229,229,0.9), rgba(209,213,219,0.9), rgba(186,12,47,0.3)),
                    url('https://www.uga.edu/img/prism-background.57f15081.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height:100dvh;
        }
        .container{max-width:1100px;margin:36px auto;padding:0 20px}

        .card{
            background:var(--card); border:1px solid var(--line); border-radius:16px;
            padding:20px; box-shadow:0 10px 25px rgba(0,0,0,.06), inset 0 1px 0 rgba(255,255,255,.5);
            margin:14px 0;
        }

        /* ======= HEADER (to match your screenshot) ======= */
        .hero{display:grid; grid-template-columns:1fr auto; gap:24px; align-items:center;

        }
        .kicker{
            text-transform:uppercase; letter-spacing:.12em; font-weight:700; font-size:.75rem; color:#9aa0a6; margin-bottom:.35rem;
        }
        .hero-title{font-weight:800; font-size:1.6rem; line-height:1.2; margin:.1rem 0 .4rem}
        .hero-desc{color:#4b5563; margin:0}
        .hero-links{display:flex; flex-direction:column; gap:10px}
        .pill-link{
            display:inline-flex; align-items:center; gap:.55rem; text-decoration:none;
            padding:.6rem .85rem; border:1px solid var(--line); border-radius:999px; background:#fff; color:#111827; font-weight:600;
            box-shadow:0 2px 8px rgba(0,0,0,.04);
        }
        .pill-link:hover{border-color:#d1d5db; transform:translateY(-1px)}
        .pill-link .i{
            width:16px; height:16px; display:inline-block; background:no-repeat center/16px 16px
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' stroke='%23374151' stroke-width='1.8' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M10.5 5.5l-5 5'/%3E%3Cpath d='M8.5 3.5h4v4'/%3E%3Cpath d='M7.5 12.5h-4v-4'/%3E%3C/svg%3E");
        }
        h2 {display:flex; align-items:center; gap:.5rem; font-weight:700; font-size: 1.5rem; color: #404040; margin:0 auto 0 10px}

        /* ======= PROGRESS ======= */
        .section-head{display:flex; align-items:center; gap:.5rem; font-weight:700; color:#404040; margin-bottom:10px}



        /* ======= TEST CARD ======= */
        .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
        .select, .btn{padding:.55rem .8rem; border-radius:10px; border:1px solid var(--line); background:#fff}
        .btn{border:0; cursor:pointer; font-weight:700; background:var(--uga-red); color:#fff; box-shadow:0 6px 18px rgba(186,12,47,.25)}
        .btn:focus{outline:4px solid var(--ring)}
        .helper{color:var(--muted); font-size:.9rem}

        .form-row{display:grid; grid-template-columns:minmax(220px,1fr) 2fr; gap:14px; align-items:start; padding:12px 0; border-top:1px dashed var(--line)}
        .form-row:first-child{border-top:0}
        .q-text{font-weight:600}
        .answers{display:flex; flex-wrap:wrap; gap:16px; align-items:center}
        .notes{width:100%; min-height:66px; resize:vertical; padding:10px; border:1px solid var(--line); border-radius:10px}

        /* Modern radios (accessible) */
        .choice{--size:18px; display:inline-flex; align-items:center; gap:.45rem; cursor:pointer; user-select:none}
        .choice input{position:absolute; opacity:0; width:0; height:0}
        .control{width:var(--size); height:var(--size); border-radius:999px; border:2px solid #c7cbd1; display:inline-grid; place-items:center; transition:border-color .2s, box-shadow .2s}
        .control::after{content:""; width:calc(var(--size) - 8px); height:calc(var(--size) - 8px); border-radius:999px; background:transparent; transition:background .15s}
        .choice input:checked + .control{border-color:var(--uga-red); box-shadow:0 0 0 3px var(--ring)}
        .choice input:checked + .control::after{background:var(--uga-red)}
        .pill{display:inline-flex; align-items:center; gap:.35rem; padding:.2rem .55rem; border-radius:999px; background:#F3F4F6; color:#374151; font-size:.8rem}

        /* Keep these hidden so the script can still target them later */
        #item-slug, #test-run-pill { display:none }

        @media (max-width:800px){
            .hero{grid-template-columns:1fr}
            .hero-links{flex-direction:row; flex-wrap:wrap}
            .form-row{grid-template-columns:1fr}
        }


        /* container + progress line */
        .steps.wide{
            position:relative; display:flex; justify-content:space-between; align-items:flex-start;
            margin:1.5rem 0; --progress:0%;
        }
        /* gray track and blue bar – both span from first to last circle center */
        .steps.wide::before,
        .steps.wide::after{
            content:""; position:absolute; height:4px; z-index:0;
            top:calc(var(--circle-d)/2);
            left:calc(var(--step-w)/2); right:calc(var(--step-w)/2); /* circles touch the line */
        }
        .steps.wide::before{ background:#e5e7eb; }                /* track */
        .steps.wide::after { background:var(--accent); z-index:1;  /* bar (clipped by --progress) */
            clip-path: inset(0 calc(100% - var(--progress)) 0 0);
        }

        /* steps and circles */
        .steps.wide .step{
            width:var(--step-w); display:flex; flex-direction:column; align-items:center; text-align:center;
            position:relative; z-index:2;  /* above the line */
        }
        .steps.wide .step::before{
            content:""; width:var(--circle-d); height:var(--circle-d); border-radius:9999px;
            background:#fff; border:2px solid #d1d5db; box-sizing:border-box;
            display:flex; align-items:center; justify-content:center; margin-bottom:.5rem;
            color:#9ca3af; font:900 1.6rem/1 "Font Awesome 6 Free";
        }

        /* icons via CSS only (no JS) */
        .steps.wide .step:nth-child(1)::before{ content:"\f568"; } /* fa-compass-drafting */
        .steps.wide .step:nth-child(2)::before{ content:"\f6e3"; } /* fa-hammer */
        .steps.wide .step:nth-child(3)::before{ content:"\f46c"; } /* fa-file-circle-check */

        /* labels */
        .steps.wide .step strong{ font-size:.875rem; font-weight:600; color:#6b7280; }
        .steps.wide .step small { font-size:.75rem; color:#9ca3af; }

        /* states from your function: .pending (active), .ok (complete) */
        .steps.wide .step.pending::before,
        .steps.wide .step.ok::before{ border-color:var(--accent); color:var(--accent); }
        .steps.wide .step.ok::before{ background:var(--accent); color:#fff; }
        .steps.wide .step.ok strong{ color:#111827; }
        .steps.wide .step.pending strong{ color:var(--accent); }

        /* progress snapping (order matters; last rule wins) */
        .steps.wide:has(.step:nth-child(1).ok){ --progress:50%; }
        .steps.wide:has(.step:nth-child(2).ok){ --progress:100%; }

        .progress-wrap{
            /* set the overall width you want */
            max-width: 660px;         /* or 480px / 36rem / whatever */
            margin-inline: auto;      /* center it */
            /* safety so circles don’t overlap */
            min-width: calc(var(--step-w) * 3);
        }

        /* 4-digit tester code entry */
        .test-wrap{display:flex; flex-direction:column; gap:.9rem}
        .code-inputs{display:flex; gap:.6rem}
        .code-input{
            width:3.2rem; height:3.4rem; text-align:center; font-size:1.6rem; font-weight:700;
            border-radius:12px; border:1.5px solid #d1d5db; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.05);
        }
        .code-input:focus{outline:3px solid rgba(186, 12, 47, 0.7); outline-offset:2px; border-color:var(--uga-red)}
        .btn-primary{display:inline-flex; align-items:center; gap:.5rem; padding:.6rem 1rem; border-radius:12px; background:var(--uga-red); color:#fff; border:0; cursor:pointer; font-weight:700}
        .btn-primary[disabled]{opacity:.6; cursor:not-allowed}
        .btn-primary:focus{outline:3px solid rgb(186, 12, 47); outline-offset:2px}
        .status{font-size:.95rem}
        .status.ok{color:#0f7b45}
        .status.err{color:#b91c1c}
        .visually-hidden{position:absolute; left:-9999px}
        /* 4-digit tester code entry */
        .code-inputs{display:flex; gap:.6rem; align-items:center}
        .code-input{
            width:3.2rem; height:3.4rem; text-align:center; font-size:1.6rem; font-weight:700;
            border-radius:12px; border:1.5px solid #d1d5db; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.05);
        }
        .code-input:focus{outline:3px solid rgba(186,12,47,.35); outline-offset:2px; border-color:var(--uga-red)}
        .btn-primary{
            display:inline-flex; align-items:center; gap:.5rem; padding:.6rem 1rem;
            border-radius:12px; background:var(--uga-red); color:#fff; border:0; cursor:pointer; font-weight:700
        }
        .btn-primary[disabled]{background:var(--uga-gray); opacity:.6; cursor:not-allowed}
        .visually-hidden{position:absolute; left:-9999px}

        #tester-controls, .controls {
            display: block !important; /* override any flex layout */
        }

        .code-inputs {
            display: flex; gap: .6rem;
            margin: 0.6rem 0; /* add breathing room */
        }

        #beginBtn {
            margin: 0.6rem 0; /* space above/below the button */
        }
        /* Center the "setup" section of the Test card */
        .test-setup {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;   /* center text like the directions */
            gap: 0.9rem;          /* even spacing between children */
            margin: 1rem 0 1.5rem;
        }

        .test-setup .code-inputs {
            display: flex;
            gap: 0.6rem;
            justify-content: center;
        }

        .form-row {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;                /* space between q-text, answers, and notes */
            padding: 14px 0;
            border-top: 1px dashed var(--line);
        }

        .form-row:first-child {
            border-top: 0;
        }

        .q-text {
            font-weight: 600;
            line-height: 1.4;
        }

        .answers {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem 1.5rem;           /* row + column spacing for radios */
        }

        .notes {
            width: 100%;
            min-height: 70px;
            resize: vertical;
            padding: 10px;
            border: 1px solid var(--line);
            border-radius: 10px;
            font-size: 0.9rem;
        }
        /* Container (optional if you only show one card) */


        /* Body */
        /* Body */
        .plan {
            white-space: pre-wrap;     /* preserve Sheet line breaks */
            color: #1f2937;            /* slate-800 */
            font-size: 1rem;
            line-height: 1.5;
            margin: 10px 20px;            /* match header side margin */
        }

        .plan p {
            margin: 1rem 0;            /* balanced vertical rhythm */
        }

        .plan ul,
        .plan ol {
            margin: 1rem 0 1rem 2rem;  /* list indentation consistent with header */
            padding-left: 0;           /* avoids double-indentation */
        }

        .plan li {
            margin: 0.5rem 0;          /* more natural spacing between items */
        }

        .plan a {
            text-decoration: underline;
        }




    </style>
</head>
<body>
<div class="container" id="app">
    <nav aria-label="Breadcrumb" style="font-size:16px;color:#666;margin:0 0 8px">
        <a href="index.html" style="color:var(--uga-red);text-decoration:none">← Return to Dashboard</a>
        <span style="margin:0 6px">/</span>
        <span id="crumb-item">Current Item</span>
    </nav>
    <!-- ===== HEADER (Dummy values) ===== -->
    <section class="card hero">
        <div>
            <div id="item-category" class="kicker">LOADING</div>
            <h1 id="item-title" class="hero-title">CONTENT</h1>
            <p id="item-description" class="hero-desc">

            </p>
        </div>
        <div class="hero-links">
            <a id="orig-link" href="#" class="pill-link"><span class="i" aria-hidden="true"></span><span>Original URL</span></a>
            <a id="new-link"  href="#" class="pill-link"><span class="i" aria-hidden="true"></span><span>New URL</span></a>
        </div>
        <!-- kept for script compatibility; hidden via CSS -->
        <span id="item-slug">casis</span>
        <span id="test-run-pill">Test ID: —</span>
    </section>

    <!-- ===== PROGRESS (Dummy values from item row: s1/s2/s3 + labels) ===== -->
    <!-- ===== PROGRESS ===== -->
    <section class="card" aria-labelledby="progTitle">
        <div class="section-head">
            <h2 id="progTitle" class="card-title">Progress</h2>
        </div>
        <div class="progress-wrap">
        <div class="steps wide" id="progress-steps" role="list" aria-label="Plan, Build, Test progress">
            <div class="step ok" role="listitem"><strong>Plan</strong><small>Done</small></div>
            <div class="step pending" role="listitem"><strong>Build</strong><small>In Progress</small></div>
            <div class="step" role="listitem"><strong>Test</strong><small>To Do</small></div>
        </div>
        </div>
    </section>
    <!-- ===== PLAN ===== -->

    <section id="plan-cards"></section>

    <!-- ===== TEST (Dummy questions for category=WebApps, stage=Test) ===== -->
    <section class="card" aria-labelledby="testTitle">
        <h2 id="testTitle" class="card-title">Test</h2>

        <div class="test-setup">
            <p id="testHelp" class="hint">
                Enter your assigned 4-digit code, then press <strong>Begin Testing</strong>.
            </p>

            <div class="code-inputs" aria-describedby="testHelp">
                <input id="code1" class="code-input" type="text" maxlength="1" inputmode="numeric" />
                <input id="code2" class="code-input" type="text" maxlength="1" inputmode="numeric" />
                <input id="code3" class="code-input" type="text" maxlength="1" inputmode="numeric" />
                <input id="code4" class="code-input" type="text" maxlength="1" inputmode="numeric" />
            </div>

            <button id="beginBtn" class="btn-primary" type="button" disabled>Begin Testing</button>
            <div id="testStatus" class="status" aria-live="polite"></div>
        </div>

<!--        <div class="helper">Questions are filtered by this item’s category and the “Test” stage.</div>-->

        <form id="testForm" style="margin-top:10px">
            <!-- Dummy Qs from Questions sheet (category=WebApps, stage=Test) -->
            <div class="form-row" data-qid="WA-T-001">
                <div class="q-text"><div class="pill" style="margin-bottom:6px">QID: WA-T-001</div>Can the app be used with keyboard only?</div>
                <div>
                    <div class="answers" role="group" aria-label="Answers for WA-T-001">
                        <label class="choice"><input type="radio" name="ans-WA-T-001" value="Yes"><span class="control"></span>Yes</label>
                        <label class="choice"><input type="radio" name="ans-WA-T-001" value="No"><span class="control"></span>No</label>
                        <label class="choice"><input type="radio" name="ans-WA-T-001" value="N/A"><span class="control"></span>N/A</label>
                    </div>
                    <textarea id="note-WA-T-001" class="notes" placeholder="Notes (optional)"></textarea>
                </div>
            </div>

            <div class="form-row" data-qid="WA-T-002">
                <div class="q-text"><div class="pill" style="margin-bottom:6px">QID: WA-T-002</div>Are focus states visible and consistent?</div>
                <div>
                    <div class="answers" role="group" aria-label="Answers for WA-T-002">
                        <label class="choice"><input type="radio" name="ans-WA-T-002" value="Yes"><span class="control"></span>Yes</label>
                        <label class="choice"><input type="radio" name="ans-WA-T-002" value="No"><span class="control"></span>No</label>
                        <label class="choice"><input type="radio" name="ans-WA-T-002" value="N/A"><span class="control"></span>N/A</label>
                    </div>
                    <textarea id="note-WA-T-002" class="notes" placeholder="Notes (optional)"></textarea>
                </div>
            </div>

            <div class="form-row" data-qid="WA-T-003">
                <div class="q-text"><div class="pill" style="margin-bottom:6px">QID: WA-T-003</div>Does the app reflow and remain usable at 400% zoom?</div>
                <div>
                    <div class="answers" role="group" aria-label="Answers for WA-T-003">
                        <label class="choice"><input type="radio" name="ans-WA-T-003" value="Yes"><span class="control"></span>Yes</label>
                        <label class="choice"><input type="radio" name="ans-WA-T-003" value="No"><span class="control"></span>No</label>
                        <label class="choice"><input type="radio" name="ans-WA-T-003" value="N/A"><span class="control"></span>N/A</label>
                    </div>
                    <textarea id="note-WA-T-003" class="notes" placeholder="Notes (optional)"></textarea>
                </div>
            </div>

            <div style="margin-top:14px; display:flex; gap:10px; align-items:center">
                <button class="btn" type="submit" id="submitBtn" disabled>Submit Answers</button>
                <span class="pill" id="questions-count">3 questions</span>
                <span class="pill" id="answers-target">Answers → Answers sheet</span>
            </div>
        </form>
    </section>

</div>
<!--code script-->
<script>
    const inputs = document.querySelectorAll('.code-input');
    const beginBtn = document.getElementById('beginBtn');
    inputs.forEach((inp,i) => {
        inp.addEventListener('input', e => {
            if (inp.value.length === 1 && i < inputs.length-1) inputs[i+1].focus();
            beginBtn.disabled = [...inputs].some(x => x.value.length !== 1);
        });
        inp.addEventListener('keydown', e => {
            if(e.key === 'Backspace' && !inp.value && i>0) inputs[i-1].focus();
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
    (() => {
        // ========== CONFIG ==========
        const SHEET_ID = '1naeWFQsNyjY3g0yNeZHcAg5VW-DTdOehH_Zjy3pCe7k';              // <-- your real Google Sheet ID
        window.SHEET_ID = SHEET_ID; // <-- make it visible to the debug panel and any out-of-scope code

        const CATEGORY_SHEETS = ['WebApps','Forms','PDFs','Media'];
        const SHEET_QUESTIONS = 'Questions';
        const SHEET_DECISIONS = 'Decisions';
        const SHEET_TESTERS   = 'Testers';                      // not required for code entry, but kept if you need it later
        const ANSWERS_ENDPOINT = 'https://script.google.com/macros/s/REPLACE_ME/exec'; // <-- Apps Script writer; leave REPLACE_ME for DRY RUN

        // ========== DOM SHORTCUTS ==========
        const $  = (s, el=document) => el.querySelector(s);
        const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));

        // Required elements from your template:
        const elTitle   = $('#item-title');
        const elCat     = $('#item-category');
        const elDesc    = $('#item-description');
        const elOrig    = $('#orig-link');
        const elNew     = $('#new-link');
        const elSteps   = $('#progress-steps');
        const elSlug    = $('#item-slug');          // can be hidden
        const elRunPill = $('#test-run-pill');      // can be hidden
        const elQCount  = $('#questions-count');
        const elForm    = $('#testForm');
        const elSubmit  = $('#submitBtn');
        const elStatus  = $('#testStatus');

        // Code-entry bits (must exist in template):
        const codeInputs = ['code1','code2','code3','code4'].map(id => document.getElementById(id)).filter(Boolean);
        const beginBtn   = document.getElementById('beginBtn');

        // ========== HELPERS ==========
        const qs = new URLSearchParams(location.search);
        const SLUG = (qs.get('slug') || (elSlug?.textContent || '')).trim();

        const csvUrl = (sheet) =>
            `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheet)}&v=${Date.now()}`;

        const nKey = k => String(k||'').trim().toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'');
        const nStr = v => String(v ?? '').trim();
        const nCmp = v => nStr(v).toLowerCase();

        function parseCSV(text){
            text = text.replace(/^\uFEFF/,'');
            const rows = [];
            let i=0, f='', row=[], q=false;
            while(i<text.length){
                const c=text[i];
                if(q){
                    if(c === '"'){
                        if(text[i+1] === '"'){ f+='"'; i+=2; continue; }
                        q=false; i++; continue;
                    }
                    f+=c; i++; continue;
                }else{
                    if(c === '"'){ q=true; i++; continue; }
                    if(c === ','){ row.push(f); f=''; i++; continue; }
                    if(c === '\r'){ i++; continue; }
                    if(c === '\n'){ row.push(f); rows.push(row); f=''; row=[]; i++; continue; }
                    f+=c; i++;
                }
            }
            if(f.length || row.length){ row.push(f); rows.push(row); }
            if(!rows.length) return [];
            const header = rows[0].map(nKey);
            return rows.slice(1)
                .filter(r => r.some(v => String(v||'').trim() !== ''))
                .map(r => {
                    const obj={};
                    for(let j=0;j<header.length;j++) obj[header[j]] = nStr(r[j] ?? '');
                    return obj;
                });
        }

        async function fetchSheet(sheet){
            const res = await fetch(csvUrl(sheet));
            if(!res.ok) throw new Error(`Fetch failed for ${sheet}: ${res.status}`);
            return parseCSV(await res.text());
        }

        function normStatus(v){
            const t = nCmp(v);
            if(['2','done','complete','completed','true','yes','ok','y','✅','pass','passed','ready','approved'].includes(t)) return 2;
            if(['1','in progress','in-progress','started','wip','partial','ongoing','doing'].includes(t)) return 1;
            return 0;
        }

        function yyyymmdd(d=new Date()){
            return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
        }

        function createStep(label, status){
            const div = document.createElement('div');
            div.className = 'step' + (status===2 ? ' ok' : status===1 ? ' pending' : '');
            div.setAttribute('role','listitem');
            div.innerHTML = `<strong>${label || ''}</strong><small>${
                status===2 ? 'Done' : status===1 ? 'In Progress' : 'To Do'
            }</small>`;
            return div;
        }

        function ensureStepsClass(){
            if(elSteps && !elSteps.classList.contains('steps')) elSteps.classList.add('steps'); // for your CSS
        }

        // ========== RENDERERS ==========
        function renderHeader(item){
            const title = item.title || '(Untitled)';
            const category = item.category || '';
            const desc = item.description || '—';
            elTitle && (elTitle.textContent = title);
            elCat   && (elCat.textContent   = (category || '').toUpperCase());
            elDesc  && (elDesc.textContent  = desc);
            const o = item.original_url || '';
            const n = item.new_url || '';
            if(elOrig){ elOrig.href = o || '#'; elOrig.style.display = o ? '' : 'none'; }
            if(elNew ){ elNew.href  = n || '#'; elNew.style.display  = n ? '' : 'none'; }
            if(elSlug){ elSlug.textContent = item.slug || SLUG; } // keep for run id build
        }

        function renderProgress(item){
            ensureStepsClass();
            const s1 = normStatus(item.s1), s2 = normStatus(item.s2), s3 = normStatus(item.s3);
            const l1 = item.s1_label || 'Plan';
            const l2 = item.s2_label || 'Build';
            const l3 = item.s3_label || 'Test';
            if(elSteps){
                elSteps.innerHTML = ''; // clear dummy
                elSteps.appendChild(createStep(l1, s1));
                elSteps.appendChild(createStep(l2, s2));
                elSteps.appendChild(createStep(l3, s3));
            }
        }

        async function renderQuestions(category){
            const qs = await fetchSheet(SHEET_QUESTIONS);
            const items = qs.filter(q => nCmp(q.category) === nCmp(category) && nCmp(q.stage) === 'test');
            if(elQCount) elQCount.textContent = `${items.length} question${items.length===1?'':'s'}`;

            // keep stacked layout: question → answers → notes
            const blocks = items.map(q => {
                const qid = q.qid;
                const text = q.text || '';
                return `
        <div class="form-row" data-qid="${qid}">
          <div class="q-text">
            <div class="pill" style="margin-bottom:6px">QID: ${qid}</div>
            ${text}
          </div>
          <div class="answers" role="group" aria-label="Answers for ${qid}">
            <label class="choice"><input type="radio" name="ans-${qid}" value="Yes"><span class="control"></span> Yes</label>
            <label class="choice"><input type="radio" name="ans-${qid}" value="No"><span class="control"></span> No</label>
            <label class="choice"><input type="radio" name="ans-${qid}" value="N/A"><span class="control"></span> N/A</label>
          </div>
          <textarea id="note-${qid}" class="notes" placeholder="Notes (optional)"></textarea>
        </div>
      `;
            }).join('');

            // Rebuild form (preserve the submit row already in your template)
            if(elForm){
                // find submit row to keep at bottom
                const submitRow = elForm.querySelector('[role="submit-row"]') || elForm.lastElementChild;
                elForm.innerHTML = blocks + (submitRow ? submitRow.outerHTML : `
        <div style="margin-top:14px; display:flex; gap:10px; align-items:center" role="submit-row">
          <button class="btn" type="submit" id="submitBtn" disabled>Submit Answers</button>
          <span class="pill" id="answers-target">Answers → Answers sheet</span>
        </div>
      `);
                // rebind elSubmit if it got replaced
                if(!document.getElementById('submitBtn')){
                    const b=document.createElement('button'); b.id='submitBtn'; b.type='submit'; b.className='btn'; b.textContent='Submit Answers'; b.disabled=true;
                    elForm.appendChild(b);
                }
            }
        }

        // ========== LOOKUP ITEM BY SLUG ==========
        async function fetchItemBySlug(slug){
            for(const sheet of CATEGORY_SHEETS){
                const rows = await fetchSheet(sheet);
                const hit = rows.find(r => nCmp(r.slug) === nCmp(slug));
                if(hit) return {sheet, row: hit};
            }
            return null;
        }


        // ========== TESTER CODE ENTRY ==========
        function wireCodeEntry(){
            // hidden input to carry tester_id for submit
            let hidden = document.getElementById('testerHidden');
            if(!hidden){
                hidden = document.createElement('input');
                hidden.type='hidden'; hidden.id='testerHidden'; hidden.name='testerHidden';
                elForm && elForm.appendChild(hidden);
            }

            function allDigits(){ return codeInputs.length===4 && codeInputs.every(i => /^[0-9]$/.test(i.value)); }
            function code(){ return codeInputs.map(i=>i.value).join(''); }

            codeInputs.forEach((inp, i) => {
                inp.addEventListener('input', () => {
                    inp.value = inp.value.replace(/[^0-9]/g,'').slice(0,1);
                    if(inp.value && i < codeInputs.length-1) codeInputs[i+1].focus();
                    if(beginBtn) beginBtn.disabled = !allDigits();
                });
                inp.addEventListener('keydown', (e) => {
                    if(e.key === 'Backspace' && !inp.value && i>0) codeInputs[i-1].focus();
                });
            });

            beginBtn && beginBtn.addEventListener('click', () => {
                if(!allDigits()) return;
                const testerId = `t${code()}`;
                const runId = `${SLUG || 'item'}-${yyyymmdd()}-${testerId}`;
                hidden.value = testerId;
                if(elRunPill) elRunPill.textContent = `Test ID: ${runId}`; // fine if hidden via CSS
                if(elStatus){ elStatus.textContent = `Tester ID set to ${testerId}. You can answer and submit.`; elStatus.className='status ok'; }
                const submit = document.getElementById('submitBtn');
                if(submit) submit.disabled = false;
            });

            // guard submit if tester not set
            elForm && elForm.addEventListener('submit', (e) => {
                if(!hidden.value){
                    e.preventDefault();
                    alert('Please enter your 4-digit tester code and click “Begin Testing” before submitting.');
                }
            }, true);
        }

        // ========== COLLECT & POST ANSWERS ==========
        async function postAnswerRow(row){
            if(ANSWERS_ENDPOINT.includes('REPLACE_ME')){
                console.log('DRY RUN → would POST:', row);
                return {ok:true, dryRun:true};
            }
            const res = await fetch(ANSWERS_ENDPOINT, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify(row),
            });
            if(!res.ok){
                const txt = await res.text().catch(()=> '');
                throw new Error(`Write failed (${res.status}): ${txt}`);
            }
            return res.json().catch(()=> ({}));
        }

        function collectAnswerRows({slug, category, testerId, testRunId}){
            const rows = [];
            $$('#testForm .form-row[data-qid]').forEach(div => {
                const qid = div.getAttribute('data-qid');
                const chosen = $(`input[name="ans-${qid}"]:checked`, div);
                const answer = chosen ? chosen.value : '';
                const notes = $(`#note-${qid}`, div)?.value || '';
                if(answer){
                    rows.push({
                        slug, category, qid, answer,
                        tester_id: testerId,
                        notes,
                        timestamp: new Date().toISOString(),
                        test_run_id: testRunId
                    });
                }
            });
            return rows;
        }

        // ========== INIT ==========
        (async function init(){
            if(!SLUG){
                elTitle && (elTitle.textContent = 'Missing ?slug=');
                return;
            }

            const hit = await fetchItemBySlug(SLUG);
            if(!hit){
                elTitle && (elTitle.textContent = 'Item not found');
                console.warn(`No row matched slug ${SLUG} in ${CATEGORY_SHEETS.join(', ')}`);
                return;
            }

            // 1) top info
            renderHeader(hit.row);

            // 2) progress
            renderProgress(hit.row);



            // 3) questions (category from row or sheet)
            await renderQuestions(hit.row.category || hit.sheet);

            // 4) wire tester code entry + submit
            wireCodeEntry();

            // 5) hook submit to Answers sheet
            const submit = document.getElementById('submitBtn');
            if(submit && elForm){
                elForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const testerId = (document.getElementById('testerHidden')?.value || '').trim();
                    if(!testerId){
                        alert('Please enter your tester code and press Begin Testing.');
                        return;
                    }
                    const runId = (elRunPill?.textContent || '').replace('Test ID:','').trim() ||
                        `${SLUG}-${yyyymmdd()}-${testerId}`;

                    const rows = collectAnswerRows({slug: hit.row.slug || SLUG, category: hit.row.category || hit.sheet, testerId, testRunId: runId});
                    if(!rows.length){
                        alert('Please answer at least one question before submitting.');
                        return;
                    }

                    try{
                        for(const r of rows) await postAnswerRow(r);
                        alert('Answers submitted. Thank you!');
                        submit.disabled = true;
                    }catch(err){
                        console.error(err);
                        alert('There was a problem saving your answers. Check console for details.');
                    }
                });
            }
        })();
/* ===== PLAN (single rich card with bracket-tags + Decisions) ===== */

  // --- minimal utilities for the markup/decisions feature (scoped to this IIFE) ---
  const PC = (() => {
    const ALLOWED = new Set(['H3','P','UL','LI','A','IMG','FIGURE','FIGCAPTION','ASIDE','PRE','CODE','BR']);
    const BRAND_RED = '#BA0C2F';

    function injectStyles(){
      if (document.getElementById('pc-styles')) return;
      const css = `
        .pc-note{border-left:4px solid ${BRAND_RED}; background:#fafafa; padding:.75rem 1rem; border-radius:.5rem}
        .pc-img{margin:0.5rem 0}
        .pc-img img{max-width:100%; height:auto; display:block; border-radius:.5rem}
        .pc-decisions{margin-top:1.25rem}
        .pc-decisions h3{margin:.25rem 0 .5rem 0}
        .pc-decision{border:1px solid #e5e7eb; border-radius:.75rem; padding:.75rem 1rem; margin:.5rem 0}
        .pc-decision .pc-key{font-weight:600}
        .pc-muted{opacity:.85}
      `;
      const s = document.createElement('style');
      s.id = 'pc-styles'; s.textContent = css; document.head.appendChild(s);
    }
    const escapeHTML = (s) => (s==null?'':String(s))
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    const escapeAttr = (s) => (s==null?'':String(s))
      .replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    function parseAttrs(s){
  const out = {};
  if (!s) return out;

  // decode quotes that got escaped earlier by escapeHTML
  s = s.replace(/&quot;|&#34;/g, '"').replace(/&#39;|&apos;/g, "'");

  // support quoted OR unquoted values: src="..." | src='...' | src=https://...
  const re = /(\w+)\s*=\s*(?:"([^"]*)"|'([^']*)'|([^\s"'\\]]+))/g;
  let m;
  while ((m = re.exec(s))) out[m[1].toLowerCase()] = m[2] ?? m[3] ?? m[4] ?? '';
  return out;
}

    function convertBracketTagsToHTML(escaped){
      let s = escaped;

      // protect [code]...[/code]
      const codeMap = [];
      s = s.replace(/\[code\]([\s\S]*?)\[\/code\]/gi, (_,inner)=>`@@CODE${codeMap.push(inner)-1}@@`);

      // blocks
      s = s.replace(/\[h3\]([\s\S]*?)\[\/h3\]/gi,'<h3>$1</h3>');
      s = s.replace(/\[p\]([\s\S]*?)\[\/p\]/gi,'<p>$1</p>');
      s = s.replace(/\[ul\]/gi,'<ul>').replace(/\[\/ul\]/gi,'</ul>');
      s = s.replace(/\[li\]/gi,'<li>').replace(/\[\/li\]/gi,'</li>');

      // [a url="..."]text[/a]
      s = s.replace(/\[a\s+url=(?:"|')([^"']+)(?:"|')\]([\s\S]*?)\[\/a\]/gi,
        (_,url,text)=>`<a href="${escapeAttr(url)}">${text}</a>`);

      // [img src="..." alt="..."]
      s = s.replace(/\[img([^\]]*)\]/gi, (_,attrs)=>{
        const {src,alt} = parseAttrs(attrs);
        const ssrc = escapeAttr(src||''); const salt = alt?escapeHTML(alt):'';
        const cap = salt ? `<figcaption class="pc-muted">${salt}</figcaption>` : '';
        return `<figure class="pc-img"><img src="${ssrc}" alt="${salt}" loading="lazy" decoding="async">${cap}</figure>`;
      });

      // [note]...[/note]
      s = s.replace(/\[note\]([\s\S]*?)\[\/note\]/gi,'<aside class="pc-note" role="note"><p>$1</p></aside>');

      // restore code
      s = s.replace(/@@CODE(\d+)@@/g,(_,i)=>`<pre class="pc-code"><code>${codeMap[+i]||''}</code></pre>`);

      // normalize newlines
      return s.replace(/\r\n?|\n/g,'\n');
    }
    function paragraphsFromBlankLines(html){
      const parts = html.split(/\n{2,}/).map(x=>x.trim()).filter(Boolean);
      if(!parts.length) return '';
      return parts.map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join('');
    }
    function sanitizeTree(root){
      const walker = document.createTreeWalker(root, NodeFilter.SHOW_ELEMENT, null);
      const nodes=[]; while(walker.nextNode()) nodes.push(walker.currentNode);
      for(const el of nodes){
        if(!ALLOWED.has(el.tagName)){
          const frag=document.createDocumentFragment();
          while(el.firstChild) frag.appendChild(el.firstChild);
          el.replaceWith(frag); continue;
        }
        const keep=new Set();
        if(el.tagName==='A') keep.add('href');
        if(el.tagName==='IMG'){ keep.add('src'); keep.add('alt'); keep.add('loading'); keep.add('decoding'); }
        for(const a of [...el.attributes]) if(!keep.has(a.name)) el.removeAttribute(a.name);

        if(el.tagName==='A'){
          const href = el.getAttribute('href')||'';
          if(!/^https:\/\//i.test(href)){
            const t=el.textContent; el.replaceWith(document.createTextNode(t));
          }else{
            el.setAttribute('target','_blank'); el.setAttribute('rel','noopener noreferrer');
          }
        }
        if(el.tagName==='IMG'){
          const src = el.getAttribute('src')||'';
          if(!/^https:\/\//i.test(src)){
            const a=document.createElement('a');
            a.href = src||'#'; a.textContent='[image]'; a.target='_blank'; a.rel='noopener noreferrer';
            el.replaceWith(a);
          }else{
            el.setAttribute('loading','lazy'); el.setAttribute('decoding','async');
          }
        }
      }
    }
    function autoLinkTextNodes(root){
      const urlRe = /(https?:\/\/[^\s<>'"]+)/g;
      const skip = new Set(['A','CODE','PRE']);
      const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
      const targets=[];
      while(walker.nextNode()){
        const n=walker.currentNode, p=n.parentElement;
        if(!p || skip.has(p.tagName)) continue;
        if(urlRe.test(n.nodeValue)) targets.push(n);
      }
      for(const n of targets){
        const text=n.nodeValue; const frag=document.createDocumentFragment(); let last=0;
        text.replace(urlRe,(m,url,off)=>{
          if(off>last) frag.appendChild(document.createTextNode(text.slice(last,off)));
          const a=document.createElement('a'); a.href=url; a.textContent=url; a.target='_blank'; a.rel='noopener noreferrer';
          frag.appendChild(a); last=off+m.length; return m;
        });
        if(last<text.length) frag.appendChild(document.createTextNode(text.slice(last)));
        n.replaceWith(frag);
      }
    }
    function parsePlanMarkup(text){
      const escaped = escapeHTML(text||'');
      let html = convertBracketTagsToHTML(escaped);
      if(!/(<h3|<ul|<pre|<p|<figure|<aside)/i.test(html)){
        html = paragraphsFromBlankLines(html);
      }
      const tpl=document.createElement('template'); tpl.innerHTML=html;
      const root=tpl.content;
      sanitizeTree(root);
      autoLinkTextNodes(root);
      return root;
    }

    function normalizeSlug(s){ return String(s||'').trim().toLowerCase(); }
    function splitSlugs(s){
      const set=new Set();
      String(s||'').split(/[;,]/).map(x=>x.trim().toLowerCase()).filter(Boolean).forEach(x=>set.add(x));
      return set;
    }

    function renderDecisionsInto(container, decisionsRows, itemSlug){
      const slug = normalizeSlug(itemSlug||'');
      const rows = Array.isArray(decisionsRows)?decisionsRows:[];
      const matches = rows.filter(r => {
        const mark = (r.mark_complete || r.marked_complete || '').toString().trim().toLowerCase();
        if(!(mark==='yes' || mark==='true' || mark==='1')) return false;
        return splitSlugs(r.slug).has(slug);
      });
      if(!matches.length) return;

      const section=document.createElement('section');
      section.className='pc-decisions';
      const h=document.createElement('h3'); h.textContent='Decisions';
      section.appendChild(h);

      for(const r of matches){
        const wrap=document.createElement('div'); wrap.className='pc-decision';
        if(r.decision_text){
          const p=document.createElement('p'); p.innerHTML = escapeHTML(r.decision_text); wrap.appendChild(p);
        }
        if(r.decision_answer){
          const p=document.createElement('p'); p.innerHTML = `<span class="pc-key">Answer:</span> ${escapeHTML(r.decision_answer)}`; wrap.appendChild(p);
        }
        if(r.decision_comment){
          const p=document.createElement('p'); p.innerHTML = `<span class="pc-key">Comment:</span> ${escapeHTML(r.decision_comment)}`; wrap.appendChild(p);
        }
        section.appendChild(wrap);
      }

      // append after plan body if present; else at end of card
      (container.querySelector('.plan-body') || container).appendChild(section);
    }

    return { injectStyles, parsePlanMarkup, renderDecisionsInto };
  })();

  // Pull "Plan" from a parsed CSV row (headers were normalized by parseCSV -> lower_snake)
  function _getPlanFromRow(row){
    if (!row) return '';
    if (typeof row.plan === 'string') return row.plan;
    const k = Object.keys(row).find(k => String(k).trim().toLowerCase() === 'plan');
    return k ? String(row[k] || '') : '';
  }

  async function renderPlanCard(){
    const mount = document.getElementById('plan-cards');
    if (!mount) return;

    PC.injectStyles();

    const currentSlug =
      (typeof SLUG !== 'undefined' && SLUG) ? SLUG :
      new URLSearchParams(location.search).get('slug') || '';

    if (!currentSlug) { mount.innerHTML = ''; return; }

    // Look through your category sheets until we find the row for this slug
    for (const sheet of CATEGORY_SHEETS) {
      try {
        const rows = await fetchSheet(sheet);                  // your CSV fetch
        const hit  = rows.find(r => nCmp(r.slug) === nCmp(currentSlug));
        if (!hit) continue;

        const plan = _getPlanFromRow(hit);
        if (!String(plan).trim()) break;

        // Build the card skeleton first
        mount.innerHTML = `
          <article class="card plan-card" data-slug="${hit.slug || currentSlug}">
            <header class="plan-header">
              <div><h2 class="plan-title">Plan</h2></div>
            </header>
            <div class="plan-body"></div>
          </article>
        `;
        const article = mount.querySelector('article');
        const planBody = article.querySelector('.plan-body');

        // 1) Render the plan markup (bracket-tags -> safe HTML)
        const frag = PC.parsePlanMarkup(plan);
        planBody.innerHTML = '';
        planBody.appendChild(frag);

        // 2) Fetch & render Decisions that match this slug (mark_complete == yes)
        try{
          const decisionsRows = await fetchSheet(SHEET_DECISIONS);
          PC.renderDecisionsInto(article, decisionsRows, currentSlug);
        }catch(e){
          console.warn('Decisions fetch failed:', e);
        }

        return; // stop after first matching sheet
      } catch (_) {
        // ignore and try the next sheet
      }
    }

    // Nothing found — clear or show nothing
    mount.innerHTML = '';
  }

  // Run after DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', renderPlanCard, { once:true });
  } else {
    renderPlanCard();
  }



        /* ===== END PLAN ===== */

    })();
</script>
<!--slug to breadcrumb script-->
<script>
    const qs = new URLSearchParams(window.location.search);
    const slug = qs.get("slug"); // e.g. "address-change"
    if (slug) {
        document.getElementById("crumb-item").textContent =
            slug.replace(/[-_]/g, " ").replace(/\b\w/g, c => c.toUpperCase());
    }
</script>

</body>
</html>
