<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Item — Detail</title>
  <style>
    :root{ --uga-red:#BA0C2F; --border:#e5e5e5; --black:#000; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f9f9f9;color:#222}
    .wrap{max-width:960px;margin:auto;padding:24px}
    .card{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,.04);margin-bottom:20px}
    .p{padding:16px}
    .badge{display:inline-block;padding:.35rem .6rem;border-radius:999px;font-size:.75rem;border:1px solid var(--border)}
    .priority{display:inline-block;padding:.2rem .5rem;border-radius:6px;font-size:.75rem;color:#fff;background:#E0A800}
    .dot{display:inline-block;width:12px;height:12px;border-radius:50%;background:#cfcfcf;vertical-align:middle}
    .dot.ok{background:#198754}
    .dot.fail{background:#BA0C2F}
    .mini-table{width:100%;border-collapse:collapse;margin-top:10px}
    .mini-table th,.mini-table td{padding:8px 10px;border-top:1px solid var(--border);text-align:left}
    .mini-table thead{background:#fafafa}
    a{color:var(--uga-red);text-decoration:none}
  </style>
</head>
<body>
<main class="wrap">
  <div class="card">
    <div class="p">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <h1 id="item-title" style="margin:0;color:var(--uga-red)">Item — Detail</h1>
        <div><a href="index.html" class="badge">← Back to dashboard</a></div>
      </div>
      <p style="color:#666;margin:.25rem 0 1rem">
        Owner: <span id="item-owner">—</span> ·
        Priority: <span id="item-priority" class="priority">—</span>
      </p>

      <h2 style="margin:.25rem 0 .5rem">Requirements &amp; Logic (summary)</h2>
      <p id="item-summary" style="max-width:70ch;line-height:1.5">—</p>

      <div class="card" style="margin-top:16px">
        <div class="p">
          <h2 style="margin:0 0 .5rem">Defined Tests</h2>
          <table class="mini-table" aria-label="Tests">
            <thead>
            <tr><th>Test</th><th>Description</th><th>Result</th></tr>
            </thead>
            <tbody id="tests-body"><tr><td colspan="3">Loading…</td></tr></tbody>
          </table>
          <div style="font-size:.85rem;color:#666;margin-top:6px">
            <span class="dot ok" aria-hidden="true"></span> Pass ·
            <span class="dot fail" aria-hidden="true"></span> Fail ·
            <span class="dot" aria-hidden="true"></span> Not tested
          </div>
        </div>
      </div>

    </div>
  </div>
</main>

<script>
  (async () => {
    // Read ?slug=address-change from URL
    const params = new URLSearchParams(location.search);
    const SLUG = (params.get('slug') || '').toLowerCase().trim();

    const ITEMS_CSV = 'data/items.csv';   // slug,title,owner,priority,summary
    const TESTS_CSV = 'data/tests.csv';   // slug,test_id,description,result,notes,updated_by,updated_at

    // Robust CSV parser (quotes + commas supported)
    function parseCSV(text){
      const rows=[]; let field='', row=[], i=0, q=false;
      const pushF=()=>{row.push(field);field='';}, pushR=()=>{if(row.length)rows.push(row.slice());row=[];};
      while(i<text.length){
        const c=text[i];
        if(q){ if(c=='"'){ if(text[i+1]=='"'){field+='"'; i+=2; continue;} q=false; i++; continue; } field+=c; i++; continue; }
        if(c=='"'){ q=true; i++; continue; }
        if(c==','){ pushF(); i++; continue; }
        if(c=='\n'){ pushF(); pushR(); i++; continue; }
        if(c=='\r'){ i++; continue; }
        field+=c; i++;
      }
      if(field!==''||row.length){ pushF(); pushR(); }
      const header=(rows.shift()||[]).map(h=>h.trim());
      return rows.filter(r=>r.some(v=>(v||'').trim()!==''))
              .map(r=>Object.fromEntries(header.map((h,idx)=>[h,(r[idx]||'').trim()])));
    }

    const $ = (s,r=document)=>r.querySelector(s);

    // 0) Basic 404 if slug missing
    if (!SLUG) {
      $('#item-title').textContent = 'Item not specified';
      $('#tests-body').innerHTML = '<tr><td colspan="3">Missing ?slug=…</td></tr>';
      return;
    }

    // 1) Item metadata
    try{
      const itxt = await (await fetch(ITEMS_CSV,{cache:'no-store'})).text();
      const items = parseCSV(itxt);
      const item = items.find(r=>(r.slug||'').toLowerCase()===SLUG);
      if(!item){
        $('#item-title').textContent = 'Item not found';
        $('#tests-body').innerHTML = '<tr><td colspan="3">No item for this slug.</td></tr>';
        return;
      }
      $('#item-title').textContent = (item.title||SLUG) + ' — Detail';
      if(item.owner)   $('#item-owner').textContent   = item.owner;
      if(item.priority){
        const pEl = $('#item-priority');
        pEl.textContent = item.priority;
        const v = item.priority.toLowerCase();
        if (v==='high')   pEl.style.background='#BA0C2F';
        if (v==='medium') pEl.style.background='#E0A800';
        if (v==='low')    pEl.style.background='#198754';
      }
      if(item.summary) $('#item-summary').textContent = item.summary;
    }catch(e){ /* ignore */ }

    // 2) Tests for this item
    try{
      const ttxt = await (await fetch(TESTS_CSV,{cache:'no-store'})).text();
      const all = parseCSV(ttxt);
      const tests = all.filter(r=>(r.slug||'').toLowerCase()===SLUG);
      const tbody = $('#tests-body');
      tbody.innerHTML = '';

      if (!tests.length) {
        tbody.innerHTML = '<tr><td colspan="3">No tests defined yet.</td></tr>';
      } else {
        tests.forEach(t=>{
          const id=(t.test_id||'').toUpperCase();
          const desc=t.description || t.name || '';
          const res=(t.result||'').toLowerCase();
          const dot = res==='pass'?'ok':(res==='fail'?'fail':'');
          const label = res ? (res[0].toUpperCase()+res.slice(1)) : '—';
          const tr=document.createElement('tr');
          tr.innerHTML = `
            <td><strong>${id}</strong></td>
            <td>${desc.replace(/</g,'&lt;')}</td>
            <td><span class="dot ${dot}" aria-label="Latest result: ${label}"></span>
                <span class="badge" style="margin-left:6px">${label}</span></td>`;
          tbody.appendChild(tr);
        });
      }
    }catch(e){ /* ignore */ }
  })();
</script>
</body>
</html>
